"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const schematics_1 = require("@angular-devkit/schematics");
const config_1 = require("@schematics/angular/utility/config");
const tasks_1 = require("@angular-devkit/schematics/tasks");
const path = require("path");
const spawn = require('cross-spawn');
const scriptsIndexHtml = `
`;
const scriptsPolyfills = `
import '@webcomponents/webcomponentsjs/custom-elements-es5-adapter.js';

if (!window['customElements']) {
  const script = document.createElement('script');
  script.src = './assets/webcomponentsjs/bundles/webcomponents-sd-ce.js';
  document.writeln(script.outerHTML);
}
`;
function npmInstall(options) {
    return function (tree, context) {
        spawn.sync('npm', ['install', options.package, options.switch], { stdio: 'inherit' });
        return tree;
    };
}
function npmRun(options) {
    return function (tree, context) {
        spawn.sync('npm', ['run', options.script], { stdio: 'inherit' });
        return tree;
    };
}
exports.npmRun = npmRun;
function executeNodeScript(options) {
    const scriptName = options.script;
    return (tree, _context) => {
        spawn.sync('node', [scriptName], { stdio: 'inherit' });
    };
}
exports.executeNodeScript = executeNodeScript;
function addWebComponentsPolyfill(_options) {
    return (tree, _context) => {
        const project = getProject(tree, _options);
        const relProjectRootPath = project.root.replace(/[^\/]+/g, '..') || '';
        const templateSource = schematics_1.apply(schematics_1.url('./files'), [
            schematics_1.template(Object.assign({}, _options, { relProjectRootPath, projectRoot: project.root || '' })),
            schematics_1.move(project.root || '/')
        ]);
        const rule = schematics_1.chain([
            updateIndexHtml(_options),
            updatePolyfills(_options),
            updatePackageJson(project.root || '', _options),
            schematics_1.branchAndMerge(schematics_1.mergeWith(templateSource)),
        ]);
        const packageJson = loadPackageJson(tree);
        if (!packageJson['dependencies'] || !packageJson['dependencies']['@webcomponents/custom-elements']) {
            _context.addTask(new tasks_1.NodePackageInstallTask({
                packageName: '@webcomponents/custom-elements',
            }));
        }
        if (!packageJson['dependencies'] || !packageJson['dependencies']['@webcomponents/webcomponentsjs']) {
            _context.addTask(new tasks_1.NodePackageInstallTask({
                packageName: '@webcomponents/webcomponentsjs',
            }));
        }
        if ((!packageJson['dependencies'] || !packageJson['dependencies']['copy'])
            && (!packageJson['devDependencies'] || !packageJson['devDependencies']['copy'])) {
            const id = _context.addTask(new tasks_1.NodePackageInstallTask({
                packageName: 'copy',
            }));
            _context.addTask(new tasks_1.RunSchematicTask('npmRun', { script: 'npx-build-plus:copy-assets' }), [id]);
        }
        else {
            _context.addTask(new tasks_1.RunSchematicTask('npmRun', { script: 'npx-build-plus:copy-assets' }));
        }
        return rule(tree, _context);
    };
}
exports.addWebComponentsPolyfill = addWebComponentsPolyfill;
function updatePackageJson(path, _options) {
    return (tree, context) => {
        const config = loadPackageJson(tree);
        updateScripts(path, config, tree, _options);
        savePackageJson(config, tree);
        return tree;
    };
}
function updateIndexHtml(options) {
    return (tree, context) => {
        const project = getProject(tree, options);
        const fileName = `${project.sourceRoot}/index.html`;
        const indexHtml = tree.read(fileName);
        if (indexHtml === null)
            throw Error('could not read index.html');
        const contentAsString = indexHtml.toString('UTF-8');
        if (contentAsString.includes('native-shim.js')) {
            console.info('Seems like, webcomponent polyfills are already referenced by index.html');
            return;
        }
        const modifiedContent = contentAsString.replace('</body>', scriptsIndexHtml + '\n</body>');
        tree.overwrite(fileName, modifiedContent);
        return tree;
    };
}
function updatePolyfills(options) {
    return (tree, context) => {
        const project = getProject(tree, options);
        const fileName = `${project.sourceRoot}/polyfills.ts`;
        const polyfillsJs = tree.read(fileName);
        if (polyfillsJs === null)
            throw Error('could not read polyfills.ts');
        const contentAsString = polyfillsJs.toString('UTF-8');
        if (contentAsString.includes('webcomponents-loader.js')) {
            console.info('Seems like, webcomponents-loader is already referenced by polyfill.js');
            return;
        }
        const modifiedContent = contentAsString + '\n\n' + scriptsPolyfills;
        tree.overwrite(fileName, modifiedContent);
        return tree;
    };
}
function getProject(tree, options) {
    const workspace = config_1.getWorkspace(tree);
    if (!options.project) {
        options.project = Object.keys(workspace.projects)[0];
    }
    const project = workspace.projects[options.project];
    // compensate for lacking sourceRoot property
    // e. g. when project was migrated to ng7, sourceRoot is lacking
    if (!project.sourceRoot && !project.root) {
        project.sourceRoot = 'src';
    }
    else if (!project.sourceRoot) {
        project.sourceRoot = path.join(project.root, 'src');
    }
    return project;
}
function savePackageJson(config, tree) {
    const newContentAsString = JSON.stringify(config, null, 2) || '';
    tree.overwrite('package.json', newContentAsString);
}
function loadPackageJson(tree) {
    const pkg = tree.read('package.json');
    if (pkg === null)
        throw Error('could not read package.json');
    const contentAsString = pkg.toString('UTF-8');
    const config = JSON.parse(contentAsString);
    return config;
}
function updateScripts(path, config, tree, _options) {
    const script = `node ${path}copy-wc-polyfill.js`;
    if (!config['scripts']) {
        config.scripts = {};
    }
    let currentScript = config.scripts['npx-build-plus:copy-assets'];
    if (!currentScript) {
        currentScript = script;
    }
    else if (!currentScript.includes(script)) {
        currentScript += ' && ' + script;
    }
    config.scripts['npx-build-plus:copy-assets'] = currentScript;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiLi8iLCJzb3VyY2VzIjpbInNjaGVtYXRpY3Mvd2ViY29tcG9uZW50cy1wb2x5ZmlsbC9pbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLDJEQUF3STtBQUN4SSwrREFBa0U7QUFDbEUsNERBQTRGO0FBQzVGLDZCQUE2QjtBQUU3QixNQUFNLEtBQUssR0FBRyxPQUFPLENBQUMsYUFBYSxDQUFDLENBQUM7QUFFckMsTUFBTSxnQkFBZ0IsR0FBRztDQUN4QixDQUFBO0FBRUQsTUFBTSxnQkFBZ0IsR0FBRzs7Ozs7Ozs7Q0FReEIsQ0FBQztBQUVGLFNBQVMsVUFBVSxDQUFDLE9BQVk7SUFDOUIsT0FBTyxVQUFVLElBQVUsRUFBRSxPQUF5QjtRQUNwRCxLQUFLLENBQUMsSUFBSSxDQUFDLEtBQUssRUFBRSxDQUFDLFNBQVMsRUFBRSxPQUFPLENBQUMsT0FBTyxFQUFFLE9BQU8sQ0FBQyxNQUFNLENBQUMsRUFBRSxFQUFFLEtBQUssRUFBRSxTQUFTLEVBQUUsQ0FBQyxDQUFDO1FBQ3RGLE9BQU8sSUFBSSxDQUFDO0lBQ2QsQ0FBQyxDQUFBO0FBQ0gsQ0FBQztBQUVELFNBQWdCLE1BQU0sQ0FBQyxPQUFZO0lBQ2pDLE9BQU8sVUFBVSxJQUFVLEVBQUUsT0FBeUI7UUFDcEQsS0FBSyxDQUFDLElBQUksQ0FBQyxLQUFLLEVBQUUsQ0FBQyxLQUFLLEVBQUUsT0FBTyxDQUFDLE1BQU0sQ0FBQyxFQUFFLEVBQUUsS0FBSyxFQUFFLFNBQVMsRUFBRSxDQUFDLENBQUM7UUFDakUsT0FBTyxJQUFJLENBQUM7SUFDZCxDQUFDLENBQUE7QUFDSCxDQUFDO0FBTEQsd0JBS0M7QUFFRCxTQUFnQixpQkFBaUIsQ0FBQyxPQUFZO0lBQzVDLE1BQU0sVUFBVSxHQUFHLE9BQU8sQ0FBQyxNQUFNLENBQUM7SUFDbEMsT0FBTyxDQUFDLElBQVUsRUFBRSxRQUEwQixFQUFFLEVBQUU7UUFDaEQsS0FBSyxDQUFDLElBQUksQ0FBQyxNQUFNLEVBQUUsQ0FBQyxVQUFVLENBQUMsRUFBRSxFQUFFLEtBQUssRUFBRSxTQUFTLEVBQUUsQ0FBQyxDQUFDO0lBQ3pELENBQUMsQ0FBQTtBQUNILENBQUM7QUFMRCw4Q0FLQztBQUVELFNBQWdCLHdCQUF3QixDQUFDLFFBQWE7SUFDcEQsT0FBTyxDQUFDLElBQVUsRUFBRSxRQUEwQixFQUFFLEVBQUU7UUFFaEQsTUFBTSxPQUFPLEdBQUcsVUFBVSxDQUFDLElBQUksRUFBRSxRQUFRLENBQUMsQ0FBQztRQUUzQyxNQUFNLGtCQUFrQixHQUN0QixPQUFPLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxTQUFTLEVBQUUsSUFBSSxDQUFDLElBQUksRUFBRSxDQUFDO1FBRTlDLE1BQU0sY0FBYyxHQUFHLGtCQUFLLENBQUMsZ0JBQUcsQ0FBQyxTQUFTLENBQUMsRUFBRTtZQUMzQyxxQkFBUSxtQkFBTSxRQUFRLElBQUUsa0JBQWtCLEVBQUUsV0FBVyxFQUFFLE9BQU8sQ0FBQyxJQUFJLElBQUksRUFBRSxJQUFHO1lBQzlFLGlCQUFJLENBQUMsT0FBTyxDQUFDLElBQUksSUFBSSxHQUFHLENBQUM7U0FDMUIsQ0FBQyxDQUFDO1FBRUgsTUFBTSxJQUFJLEdBQUcsa0JBQUssQ0FBQztZQUNqQixlQUFlLENBQUMsUUFBUSxDQUFDO1lBQ3pCLGVBQWUsQ0FBQyxRQUFRLENBQUM7WUFDekIsaUJBQWlCLENBQUMsT0FBTyxDQUFDLElBQUksSUFBSSxFQUFFLEVBQUUsUUFBUSxDQUFDO1lBQy9DLDJCQUFjLENBQUMsc0JBQVMsQ0FBQyxjQUFjLENBQUMsQ0FBQztTQUcxQyxDQUFDLENBQUM7UUFFSCxNQUFNLFdBQVcsR0FBRyxlQUFlLENBQUMsSUFBSSxDQUFDLENBQUM7UUFFMUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxjQUFjLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxjQUFjLENBQUMsQ0FBQyxnQ0FBZ0MsQ0FBQyxFQUFFO1lBQ2xHLFFBQVEsQ0FBQyxPQUFPLENBQUMsSUFBSSw4QkFBc0IsQ0FBQztnQkFDMUMsV0FBVyxFQUFFLGdDQUFnQzthQUM5QyxDQUFDLENBQUMsQ0FBQztTQUNMO1FBRUQsSUFBSSxDQUFDLFdBQVcsQ0FBQyxjQUFjLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxjQUFjLENBQUMsQ0FBQyxnQ0FBZ0MsQ0FBQyxFQUFFO1lBQ2xHLFFBQVEsQ0FBQyxPQUFPLENBQUMsSUFBSSw4QkFBc0IsQ0FBQztnQkFDMUMsV0FBVyxFQUFFLGdDQUFnQzthQUM5QyxDQUFDLENBQUMsQ0FBQztTQUNMO1FBRUQsSUFDRSxDQUFDLENBQUMsV0FBVyxDQUFDLGNBQWMsQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLGNBQWMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDO2VBQ25FLENBQUMsQ0FBQyxXQUFXLENBQUMsaUJBQWlCLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLEVBQy9FO1lBRUEsTUFBTSxFQUFFLEdBQUcsUUFBUSxDQUFDLE9BQU8sQ0FBQyxJQUFJLDhCQUFzQixDQUFDO2dCQUNyRCxXQUFXLEVBQUUsTUFBTTthQUNwQixDQUFDLENBQUMsQ0FBQztZQUVKLFFBQVEsQ0FBQyxPQUFPLENBQUMsSUFBSSx3QkFBZ0IsQ0FBQyxRQUFRLEVBQUUsRUFBRSxNQUFNLEVBQUUsNEJBQTRCLEVBQUUsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQztTQUNsRzthQUNJO1lBQ0gsUUFBUSxDQUFDLE9BQU8sQ0FBQyxJQUFJLHdCQUFnQixDQUFDLFFBQVEsRUFBRSxFQUFFLE1BQU0sRUFBRSw0QkFBNEIsRUFBRSxDQUFDLENBQUMsQ0FBQztTQUM1RjtRQUVELE9BQU8sSUFBSSxDQUFDLElBQUksRUFBRSxRQUFRLENBQUMsQ0FBQztJQUM5QixDQUFDLENBQUM7QUFDSixDQUFDO0FBckRELDREQXFEQztBQUVELFNBQVMsaUJBQWlCLENBQUMsSUFBWSxFQUFFLFFBQWE7SUFDcEQsT0FBTyxDQUFDLElBQVUsRUFBRSxPQUF5QixFQUFFLEVBQUU7UUFDL0MsTUFBTSxNQUFNLEdBQUcsZUFBZSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ3JDLGFBQWEsQ0FBQyxJQUFJLEVBQUUsTUFBTSxFQUFFLElBQUksRUFBRSxRQUFRLENBQUMsQ0FBQztRQUM1QyxlQUFlLENBQUMsTUFBTSxFQUFFLElBQUksQ0FBQyxDQUFDO1FBQzlCLE9BQU8sSUFBSSxDQUFDO0lBQ2QsQ0FBQyxDQUFBO0FBQ0gsQ0FBQztBQUVELFNBQVMsZUFBZSxDQUFDLE9BQVk7SUFDbkMsT0FBTyxDQUFDLElBQVUsRUFBRSxPQUF5QixFQUFFLEVBQUU7UUFDL0MsTUFBTSxPQUFPLEdBQUcsVUFBVSxDQUFDLElBQUksRUFBRSxPQUFPLENBQUMsQ0FBQztRQUMxQyxNQUFNLFFBQVEsR0FBRyxHQUFHLE9BQU8sQ0FBQyxVQUFVLGFBQWEsQ0FBQztRQUVwRCxNQUFNLFNBQVMsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBQ3RDLElBQUksU0FBUyxLQUFLLElBQUk7WUFDcEIsTUFBTSxLQUFLLENBQUMsMkJBQTJCLENBQUMsQ0FBQztRQUMzQyxNQUFNLGVBQWUsR0FBRyxTQUFTLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBRXBELElBQUksZUFBZSxDQUFDLFFBQVEsQ0FBQyxnQkFBZ0IsQ0FBQyxFQUFFO1lBQzlDLE9BQU8sQ0FBQyxJQUFJLENBQUMseUVBQXlFLENBQUMsQ0FBQztZQUN4RixPQUFPO1NBQ1I7UUFFRCxNQUFNLGVBQWUsR0FBRyxlQUFlLENBQUMsT0FBTyxDQUFDLFNBQVMsRUFBRSxnQkFBZ0IsR0FBRyxXQUFXLENBQUMsQ0FBQztRQUUzRixJQUFJLENBQUMsU0FBUyxDQUFDLFFBQVEsRUFBRSxlQUFlLENBQUMsQ0FBQztRQUMxQyxPQUFPLElBQUksQ0FBQztJQUNkLENBQUMsQ0FBQTtBQUNILENBQUM7QUFFRCxTQUFTLGVBQWUsQ0FBQyxPQUFZO0lBQ25DLE9BQU8sQ0FBQyxJQUFVLEVBQUUsT0FBeUIsRUFBRSxFQUFFO1FBQy9DLE1BQU0sT0FBTyxHQUFHLFVBQVUsQ0FBQyxJQUFJLEVBQUUsT0FBTyxDQUFDLENBQUM7UUFDMUMsTUFBTSxRQUFRLEdBQUcsR0FBRyxPQUFPLENBQUMsVUFBVSxlQUFlLENBQUM7UUFFdEQsTUFBTSxXQUFXLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUN4QyxJQUFJLFdBQVcsS0FBSyxJQUFJO1lBQ3RCLE1BQU0sS0FBSyxDQUFDLDZCQUE2QixDQUFDLENBQUM7UUFDN0MsTUFBTSxlQUFlLEdBQUcsV0FBVyxDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUV0RCxJQUFJLGVBQWUsQ0FBQyxRQUFRLENBQUMseUJBQXlCLENBQUMsRUFBRTtZQUN2RCxPQUFPLENBQUMsSUFBSSxDQUFDLHVFQUF1RSxDQUFDLENBQUM7WUFDdEYsT0FBTztTQUNSO1FBRUQsTUFBTSxlQUFlLEdBQUcsZUFBZSxHQUFHLE1BQU0sR0FBRyxnQkFBZ0IsQ0FBQztRQUVwRSxJQUFJLENBQUMsU0FBUyxDQUFDLFFBQVEsRUFBRSxlQUFlLENBQUMsQ0FBQztRQUMxQyxPQUFPLElBQUksQ0FBQztJQUNkLENBQUMsQ0FBQTtBQUNILENBQUM7QUFHRCxTQUFTLFVBQVUsQ0FBQyxJQUFVLEVBQUUsT0FBWTtJQUMxQyxNQUFNLFNBQVMsR0FBRyxxQkFBWSxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQ3JDLElBQUksQ0FBQyxPQUFPLENBQUMsT0FBTyxFQUFFO1FBQ3BCLE9BQU8sQ0FBQyxPQUFPLEdBQUcsTUFBTSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7S0FDdEQ7SUFDRCxNQUFNLE9BQU8sR0FBRyxTQUFTLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsQ0FBQztJQUVwRCw2Q0FBNkM7SUFDN0MsZ0VBQWdFO0lBQ2hFLElBQUksQ0FBQyxPQUFPLENBQUMsVUFBVSxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksRUFBRTtRQUN4QyxPQUFPLENBQUMsVUFBVSxHQUFHLEtBQUssQ0FBQztLQUM1QjtTQUNJLElBQUksQ0FBQyxPQUFPLENBQUMsVUFBVSxFQUFFO1FBQzVCLE9BQU8sQ0FBQyxVQUFVLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxFQUFFLEtBQUssQ0FBQyxDQUFDO0tBQ3JEO0lBRUQsT0FBTyxPQUFPLENBQUM7QUFDakIsQ0FBQztBQUVELFNBQVMsZUFBZSxDQUFDLE1BQVcsRUFBRSxJQUFVO0lBQzlDLE1BQU0sa0JBQWtCLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxNQUFNLEVBQUUsSUFBSSxFQUFFLENBQUMsQ0FBQyxJQUFJLEVBQUUsQ0FBQztJQUNqRSxJQUFJLENBQUMsU0FBUyxDQUFDLGNBQWMsRUFBRSxrQkFBa0IsQ0FBQyxDQUFDO0FBQ3JELENBQUM7QUFFRCxTQUFTLGVBQWUsQ0FBQyxJQUFVO0lBQ2pDLE1BQU0sR0FBRyxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsY0FBYyxDQUFDLENBQUM7SUFDdEMsSUFBSSxHQUFHLEtBQUssSUFBSTtRQUNkLE1BQU0sS0FBSyxDQUFDLDZCQUE2QixDQUFDLENBQUM7SUFDN0MsTUFBTSxlQUFlLEdBQUcsR0FBRyxDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUMsQ0FBQztJQUM5QyxNQUFNLE1BQU0sR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLGVBQWUsQ0FBQyxDQUFDO0lBQzNDLE9BQU8sTUFBTSxDQUFDO0FBQ2hCLENBQUM7QUFFRCxTQUFTLGFBQWEsQ0FBQyxJQUFZLEVBQUUsTUFBVyxFQUFFLElBQVUsRUFBRSxRQUFhO0lBQ3pFLE1BQU0sTUFBTSxHQUFHLFFBQVEsSUFBSSxxQkFBcUIsQ0FBQztJQUVqRCxJQUFJLENBQUMsTUFBTSxDQUFDLFNBQVMsQ0FBQyxFQUFFO1FBQ3RCLE1BQU0sQ0FBQyxPQUFPLEdBQUcsRUFBRSxDQUFDO0tBQ3JCO0lBRUQsSUFBSSxhQUFhLEdBQVcsTUFBTSxDQUFDLE9BQU8sQ0FBQyw0QkFBNEIsQ0FBQyxDQUFDO0lBRXpFLElBQUksQ0FBQyxhQUFhLEVBQUU7UUFDbEIsYUFBYSxHQUFHLE1BQU0sQ0FBQztLQUN4QjtTQUNJLElBQUksQ0FBQyxhQUFhLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxFQUFFO1FBQ3hDLGFBQWEsSUFBSSxNQUFNLEdBQUcsTUFBTSxDQUFDO0tBQ2xDO0lBRUQsTUFBTSxDQUFDLE9BQU8sQ0FBQyw0QkFBNEIsQ0FBQyxHQUFHLGFBQWEsQ0FBQztBQUMvRCxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgUnVsZSwgU2NoZW1hdGljQ29udGV4dCwgVHJlZSwgYXBwbHksIHVybCwgdGVtcGxhdGUsIG1vdmUsIGJyYW5jaEFuZE1lcmdlLCBtZXJnZVdpdGgsIGNoYWluIH0gZnJvbSAnQGFuZ3VsYXItZGV2a2l0L3NjaGVtYXRpY3MnO1xyXG5pbXBvcnQgeyBnZXRXb3Jrc3BhY2UgfSBmcm9tICdAc2NoZW1hdGljcy9hbmd1bGFyL3V0aWxpdHkvY29uZmlnJztcclxuaW1wb3J0IHsgUnVuU2NoZW1hdGljVGFzaywgTm9kZVBhY2thZ2VJbnN0YWxsVGFzayB9IGZyb20gJ0Bhbmd1bGFyLWRldmtpdC9zY2hlbWF0aWNzL3Rhc2tzJztcclxuaW1wb3J0ICogYXMgcGF0aCBmcm9tICdwYXRoJztcclxuXHJcbmNvbnN0IHNwYXduID0gcmVxdWlyZSgnY3Jvc3Mtc3Bhd24nKTtcclxuXHJcbmNvbnN0IHNjcmlwdHNJbmRleEh0bWwgPSBgXHJcbmBcclxuXHJcbmNvbnN0IHNjcmlwdHNQb2x5ZmlsbHMgPSBgXHJcbmltcG9ydCAnQHdlYmNvbXBvbmVudHMvd2ViY29tcG9uZW50c2pzL2N1c3RvbS1lbGVtZW50cy1lczUtYWRhcHRlci5qcyc7XHJcblxyXG5pZiAoIXdpbmRvd1snY3VzdG9tRWxlbWVudHMnXSkge1xyXG4gIGNvbnN0IHNjcmlwdCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3NjcmlwdCcpO1xyXG4gIHNjcmlwdC5zcmMgPSAnLi9hc3NldHMvd2ViY29tcG9uZW50c2pzL2J1bmRsZXMvd2ViY29tcG9uZW50cy1zZC1jZS5qcyc7XHJcbiAgZG9jdW1lbnQud3JpdGVsbihzY3JpcHQub3V0ZXJIVE1MKTtcclxufVxyXG5gO1xyXG5cclxuZnVuY3Rpb24gbnBtSW5zdGFsbChvcHRpb25zOiBhbnkpOiBSdWxlIHtcclxuICByZXR1cm4gZnVuY3Rpb24gKHRyZWU6IFRyZWUsIGNvbnRleHQ6IFNjaGVtYXRpY0NvbnRleHQpIHtcclxuICAgIHNwYXduLnN5bmMoJ25wbScsIFsnaW5zdGFsbCcsIG9wdGlvbnMucGFja2FnZSwgb3B0aW9ucy5zd2l0Y2hdLCB7IHN0ZGlvOiAnaW5oZXJpdCcgfSk7XHJcbiAgICByZXR1cm4gdHJlZTtcclxuICB9XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBucG1SdW4ob3B0aW9uczogYW55KTogUnVsZSB7XHJcbiAgcmV0dXJuIGZ1bmN0aW9uICh0cmVlOiBUcmVlLCBjb250ZXh0OiBTY2hlbWF0aWNDb250ZXh0KSB7XHJcbiAgICBzcGF3bi5zeW5jKCducG0nLCBbJ3J1bicsIG9wdGlvbnMuc2NyaXB0XSwgeyBzdGRpbzogJ2luaGVyaXQnIH0pO1xyXG4gICAgcmV0dXJuIHRyZWU7XHJcbiAgfVxyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gZXhlY3V0ZU5vZGVTY3JpcHQob3B0aW9uczogYW55KTogUnVsZSB7XHJcbiAgY29uc3Qgc2NyaXB0TmFtZSA9IG9wdGlvbnMuc2NyaXB0O1xyXG4gIHJldHVybiAodHJlZTogVHJlZSwgX2NvbnRleHQ6IFNjaGVtYXRpY0NvbnRleHQpID0+IHtcclxuICAgIHNwYXduLnN5bmMoJ25vZGUnLCBbc2NyaXB0TmFtZV0sIHsgc3RkaW86ICdpbmhlcml0JyB9KTtcclxuICB9XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBhZGRXZWJDb21wb25lbnRzUG9seWZpbGwoX29wdGlvbnM6IGFueSk6IFJ1bGUge1xyXG4gIHJldHVybiAodHJlZTogVHJlZSwgX2NvbnRleHQ6IFNjaGVtYXRpY0NvbnRleHQpID0+IHtcclxuXHJcbiAgICBjb25zdCBwcm9qZWN0ID0gZ2V0UHJvamVjdCh0cmVlLCBfb3B0aW9ucyk7XHJcblxyXG4gICAgY29uc3QgcmVsUHJvamVjdFJvb3RQYXRoID1cclxuICAgICAgcHJvamVjdC5yb290LnJlcGxhY2UoL1teXFwvXSsvZywgJy4uJykgfHwgJyc7XHJcblxyXG4gICAgY29uc3QgdGVtcGxhdGVTb3VyY2UgPSBhcHBseSh1cmwoJy4vZmlsZXMnKSwgW1xyXG4gICAgICB0ZW1wbGF0ZSh7IC4uLl9vcHRpb25zLCByZWxQcm9qZWN0Um9vdFBhdGgsIHByb2plY3RSb290OiBwcm9qZWN0LnJvb3QgfHwgJycgfSksXHJcbiAgICAgIG1vdmUocHJvamVjdC5yb290IHx8ICcvJylcclxuICAgIF0pO1xyXG5cclxuICAgIGNvbnN0IHJ1bGUgPSBjaGFpbihbXHJcbiAgICAgIHVwZGF0ZUluZGV4SHRtbChfb3B0aW9ucyksXHJcbiAgICAgIHVwZGF0ZVBvbHlmaWxscyhfb3B0aW9ucyksXHJcbiAgICAgIHVwZGF0ZVBhY2thZ2VKc29uKHByb2plY3Qucm9vdCB8fCAnJywgX29wdGlvbnMpLFxyXG4gICAgICBicmFuY2hBbmRNZXJnZShtZXJnZVdpdGgodGVtcGxhdGVTb3VyY2UpKSxcclxuICAgICAgLy8gbnBtSW5zdGFsbCh7cGFja2FnZTogJ0B3ZWJjb21wb25lbnRzL2N1c3RvbS1lbGVtZW50cycsIHN3aXRjaDogJy0tc2F2ZSd9KSxcclxuICAgICAgLy8gbnBtSW5zdGFsbCh7cGFja2FnZTogJ2NvcHknLCBzd2l0Y2g6ICctLXNhdmUtZGV2J30pLFxyXG4gICAgXSk7XHJcblxyXG4gICAgY29uc3QgcGFja2FnZUpzb24gPSBsb2FkUGFja2FnZUpzb24odHJlZSk7XHJcblxyXG4gICAgaWYgKCFwYWNrYWdlSnNvblsnZGVwZW5kZW5jaWVzJ10gfHwgIXBhY2thZ2VKc29uWydkZXBlbmRlbmNpZXMnXVsnQHdlYmNvbXBvbmVudHMvY3VzdG9tLWVsZW1lbnRzJ10pIHtcclxuICAgICAgX2NvbnRleHQuYWRkVGFzayhuZXcgTm9kZVBhY2thZ2VJbnN0YWxsVGFzayh7XHJcbiAgICAgICAgcGFja2FnZU5hbWU6ICdAd2ViY29tcG9uZW50cy9jdXN0b20tZWxlbWVudHMnLFxyXG4gICAgICB9KSk7XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKCFwYWNrYWdlSnNvblsnZGVwZW5kZW5jaWVzJ10gfHwgIXBhY2thZ2VKc29uWydkZXBlbmRlbmNpZXMnXVsnQHdlYmNvbXBvbmVudHMvd2ViY29tcG9uZW50c2pzJ10pIHtcclxuICAgICAgX2NvbnRleHQuYWRkVGFzayhuZXcgTm9kZVBhY2thZ2VJbnN0YWxsVGFzayh7XHJcbiAgICAgICAgcGFja2FnZU5hbWU6ICdAd2ViY29tcG9uZW50cy93ZWJjb21wb25lbnRzanMnLFxyXG4gICAgICB9KSk7XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKFxyXG4gICAgICAoIXBhY2thZ2VKc29uWydkZXBlbmRlbmNpZXMnXSB8fCAhcGFja2FnZUpzb25bJ2RlcGVuZGVuY2llcyddWydjb3B5J10pXHJcbiAgICAgICYmICghcGFja2FnZUpzb25bJ2RldkRlcGVuZGVuY2llcyddIHx8ICFwYWNrYWdlSnNvblsnZGV2RGVwZW5kZW5jaWVzJ11bJ2NvcHknXSlcclxuICAgICkge1xyXG5cclxuICAgICAgY29uc3QgaWQgPSBfY29udGV4dC5hZGRUYXNrKG5ldyBOb2RlUGFja2FnZUluc3RhbGxUYXNrKHtcclxuICAgICAgICBwYWNrYWdlTmFtZTogJ2NvcHknLFxyXG4gICAgICB9KSk7XHJcblxyXG4gICAgICBfY29udGV4dC5hZGRUYXNrKG5ldyBSdW5TY2hlbWF0aWNUYXNrKCducG1SdW4nLCB7IHNjcmlwdDogJ25weC1idWlsZC1wbHVzOmNvcHktYXNzZXRzJyB9KSwgW2lkXSk7XHJcbiAgICB9XHJcbiAgICBlbHNlIHtcclxuICAgICAgX2NvbnRleHQuYWRkVGFzayhuZXcgUnVuU2NoZW1hdGljVGFzaygnbnBtUnVuJywgeyBzY3JpcHQ6ICducHgtYnVpbGQtcGx1czpjb3B5LWFzc2V0cycgfSkpO1xyXG4gICAgfVxyXG5cclxuICAgIHJldHVybiBydWxlKHRyZWUsIF9jb250ZXh0KTtcclxuICB9O1xyXG59XHJcblxyXG5mdW5jdGlvbiB1cGRhdGVQYWNrYWdlSnNvbihwYXRoOiBzdHJpbmcsIF9vcHRpb25zOiBhbnkpOiBSdWxlIHtcclxuICByZXR1cm4gKHRyZWU6IFRyZWUsIGNvbnRleHQ6IFNjaGVtYXRpY0NvbnRleHQpID0+IHtcclxuICAgIGNvbnN0IGNvbmZpZyA9IGxvYWRQYWNrYWdlSnNvbih0cmVlKTtcclxuICAgIHVwZGF0ZVNjcmlwdHMocGF0aCwgY29uZmlnLCB0cmVlLCBfb3B0aW9ucyk7XHJcbiAgICBzYXZlUGFja2FnZUpzb24oY29uZmlnLCB0cmVlKTtcclxuICAgIHJldHVybiB0cmVlO1xyXG4gIH1cclxufVxyXG5cclxuZnVuY3Rpb24gdXBkYXRlSW5kZXhIdG1sKG9wdGlvbnM6IGFueSk6IFJ1bGUge1xyXG4gIHJldHVybiAodHJlZTogVHJlZSwgY29udGV4dDogU2NoZW1hdGljQ29udGV4dCkgPT4ge1xyXG4gICAgY29uc3QgcHJvamVjdCA9IGdldFByb2plY3QodHJlZSwgb3B0aW9ucyk7XHJcbiAgICBjb25zdCBmaWxlTmFtZSA9IGAke3Byb2plY3Quc291cmNlUm9vdH0vaW5kZXguaHRtbGA7XHJcblxyXG4gICAgY29uc3QgaW5kZXhIdG1sID0gdHJlZS5yZWFkKGZpbGVOYW1lKTtcclxuICAgIGlmIChpbmRleEh0bWwgPT09IG51bGwpXHJcbiAgICAgIHRocm93IEVycm9yKCdjb3VsZCBub3QgcmVhZCBpbmRleC5odG1sJyk7XHJcbiAgICBjb25zdCBjb250ZW50QXNTdHJpbmcgPSBpbmRleEh0bWwudG9TdHJpbmcoJ1VURi04Jyk7XHJcblxyXG4gICAgaWYgKGNvbnRlbnRBc1N0cmluZy5pbmNsdWRlcygnbmF0aXZlLXNoaW0uanMnKSkge1xyXG4gICAgICBjb25zb2xlLmluZm8oJ1NlZW1zIGxpa2UsIHdlYmNvbXBvbmVudCBwb2x5ZmlsbHMgYXJlIGFscmVhZHkgcmVmZXJlbmNlZCBieSBpbmRleC5odG1sJyk7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuXHJcbiAgICBjb25zdCBtb2RpZmllZENvbnRlbnQgPSBjb250ZW50QXNTdHJpbmcucmVwbGFjZSgnPC9ib2R5PicsIHNjcmlwdHNJbmRleEh0bWwgKyAnXFxuPC9ib2R5PicpO1xyXG5cclxuICAgIHRyZWUub3ZlcndyaXRlKGZpbGVOYW1lLCBtb2RpZmllZENvbnRlbnQpO1xyXG4gICAgcmV0dXJuIHRyZWU7XHJcbiAgfVxyXG59XHJcblxyXG5mdW5jdGlvbiB1cGRhdGVQb2x5ZmlsbHMob3B0aW9uczogYW55KTogUnVsZSB7XHJcbiAgcmV0dXJuICh0cmVlOiBUcmVlLCBjb250ZXh0OiBTY2hlbWF0aWNDb250ZXh0KSA9PiB7XHJcbiAgICBjb25zdCBwcm9qZWN0ID0gZ2V0UHJvamVjdCh0cmVlLCBvcHRpb25zKTtcclxuICAgIGNvbnN0IGZpbGVOYW1lID0gYCR7cHJvamVjdC5zb3VyY2VSb290fS9wb2x5ZmlsbHMudHNgO1xyXG5cclxuICAgIGNvbnN0IHBvbHlmaWxsc0pzID0gdHJlZS5yZWFkKGZpbGVOYW1lKTtcclxuICAgIGlmIChwb2x5ZmlsbHNKcyA9PT0gbnVsbClcclxuICAgICAgdGhyb3cgRXJyb3IoJ2NvdWxkIG5vdCByZWFkIHBvbHlmaWxscy50cycpO1xyXG4gICAgY29uc3QgY29udGVudEFzU3RyaW5nID0gcG9seWZpbGxzSnMudG9TdHJpbmcoJ1VURi04Jyk7XHJcblxyXG4gICAgaWYgKGNvbnRlbnRBc1N0cmluZy5pbmNsdWRlcygnd2ViY29tcG9uZW50cy1sb2FkZXIuanMnKSkge1xyXG4gICAgICBjb25zb2xlLmluZm8oJ1NlZW1zIGxpa2UsIHdlYmNvbXBvbmVudHMtbG9hZGVyIGlzIGFscmVhZHkgcmVmZXJlbmNlZCBieSBwb2x5ZmlsbC5qcycpO1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcblxyXG4gICAgY29uc3QgbW9kaWZpZWRDb250ZW50ID0gY29udGVudEFzU3RyaW5nICsgJ1xcblxcbicgKyBzY3JpcHRzUG9seWZpbGxzO1xyXG5cclxuICAgIHRyZWUub3ZlcndyaXRlKGZpbGVOYW1lLCBtb2RpZmllZENvbnRlbnQpO1xyXG4gICAgcmV0dXJuIHRyZWU7XHJcbiAgfVxyXG59XHJcblxyXG5cclxuZnVuY3Rpb24gZ2V0UHJvamVjdCh0cmVlOiBUcmVlLCBvcHRpb25zOiBhbnkpIHtcclxuICBjb25zdCB3b3Jrc3BhY2UgPSBnZXRXb3Jrc3BhY2UodHJlZSk7XHJcbiAgaWYgKCFvcHRpb25zLnByb2plY3QpIHtcclxuICAgIG9wdGlvbnMucHJvamVjdCA9IE9iamVjdC5rZXlzKHdvcmtzcGFjZS5wcm9qZWN0cylbMF07XHJcbiAgfVxyXG4gIGNvbnN0IHByb2plY3QgPSB3b3Jrc3BhY2UucHJvamVjdHNbb3B0aW9ucy5wcm9qZWN0XTtcclxuXHJcbiAgLy8gY29tcGVuc2F0ZSBmb3IgbGFja2luZyBzb3VyY2VSb290IHByb3BlcnR5XHJcbiAgLy8gZS4gZy4gd2hlbiBwcm9qZWN0IHdhcyBtaWdyYXRlZCB0byBuZzcsIHNvdXJjZVJvb3QgaXMgbGFja2luZ1xyXG4gIGlmICghcHJvamVjdC5zb3VyY2VSb290ICYmICFwcm9qZWN0LnJvb3QpIHtcclxuICAgIHByb2plY3Quc291cmNlUm9vdCA9ICdzcmMnO1xyXG4gIH1cclxuICBlbHNlIGlmICghcHJvamVjdC5zb3VyY2VSb290KSB7XHJcbiAgICBwcm9qZWN0LnNvdXJjZVJvb3QgPSBwYXRoLmpvaW4ocHJvamVjdC5yb290LCAnc3JjJyk7XHJcbiAgfVxyXG5cclxuICByZXR1cm4gcHJvamVjdDtcclxufVxyXG5cclxuZnVuY3Rpb24gc2F2ZVBhY2thZ2VKc29uKGNvbmZpZzogYW55LCB0cmVlOiBUcmVlKSB7XHJcbiAgY29uc3QgbmV3Q29udGVudEFzU3RyaW5nID0gSlNPTi5zdHJpbmdpZnkoY29uZmlnLCBudWxsLCAyKSB8fCAnJztcclxuICB0cmVlLm92ZXJ3cml0ZSgncGFja2FnZS5qc29uJywgbmV3Q29udGVudEFzU3RyaW5nKTtcclxufVxyXG5cclxuZnVuY3Rpb24gbG9hZFBhY2thZ2VKc29uKHRyZWU6IFRyZWUpIHtcclxuICBjb25zdCBwa2cgPSB0cmVlLnJlYWQoJ3BhY2thZ2UuanNvbicpO1xyXG4gIGlmIChwa2cgPT09IG51bGwpXHJcbiAgICB0aHJvdyBFcnJvcignY291bGQgbm90IHJlYWQgcGFja2FnZS5qc29uJyk7XHJcbiAgY29uc3QgY29udGVudEFzU3RyaW5nID0gcGtnLnRvU3RyaW5nKCdVVEYtOCcpO1xyXG4gIGNvbnN0IGNvbmZpZyA9IEpTT04ucGFyc2UoY29udGVudEFzU3RyaW5nKTtcclxuICByZXR1cm4gY29uZmlnO1xyXG59XHJcblxyXG5mdW5jdGlvbiB1cGRhdGVTY3JpcHRzKHBhdGg6IHN0cmluZywgY29uZmlnOiBhbnksIHRyZWU6IFRyZWUsIF9vcHRpb25zOiBhbnkpIHtcclxuICBjb25zdCBzY3JpcHQgPSBgbm9kZSAke3BhdGh9Y29weS13Yy1wb2x5ZmlsbC5qc2A7XHJcblxyXG4gIGlmICghY29uZmlnWydzY3JpcHRzJ10pIHtcclxuICAgIGNvbmZpZy5zY3JpcHRzID0ge307XHJcbiAgfVxyXG5cclxuICBsZXQgY3VycmVudFNjcmlwdDogc3RyaW5nID0gY29uZmlnLnNjcmlwdHNbJ25weC1idWlsZC1wbHVzOmNvcHktYXNzZXRzJ107XHJcblxyXG4gIGlmICghY3VycmVudFNjcmlwdCkge1xyXG4gICAgY3VycmVudFNjcmlwdCA9IHNjcmlwdDtcclxuICB9XHJcbiAgZWxzZSBpZiAoIWN1cnJlbnRTY3JpcHQuaW5jbHVkZXMoc2NyaXB0KSkge1xyXG4gICAgY3VycmVudFNjcmlwdCArPSAnICYmICcgKyBzY3JpcHQ7XHJcbiAgfVxyXG5cclxuICBjb25maWcuc2NyaXB0c1snbnB4LWJ1aWxkLXBsdXM6Y29weS1hc3NldHMnXSA9IGN1cnJlbnRTY3JpcHQ7XHJcbn1cclxuXHJcbiJdfQ==