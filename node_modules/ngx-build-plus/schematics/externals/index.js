"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const schematics_1 = require("@angular-devkit/schematics");
const config_1 = require("@schematics/angular/utility/config");
const tasks_1 = require("@angular-devkit/schematics/tasks");
const path = require("path");
const spawn = require('cross-spawn');
const scripts = `

  <!-- Here, all the shared code is imported -->
  <!-- consider creating one or several bundles -->
  <!-- for those -->

  <!-- core-js for legacy browsers 
        Consider only loading for IE
  -->
  <script src="./assets/core-js/core.js"></script>

  <!-- 
        Web Component polyfills
  -->
  <script src="/assets/webcomponentsjs/bundles/webcomponents-sd-ce.js"></script>

  <!-- Zone.js 
        Consider excluding zone.js when creating
        custom Elements by using the noop zone.

        If you load zone.js with an additional 
        bundle, delete this line.
  -->
  <script src="./assets/zone.js/zone.js"></script>

  <!-- TODO: Add further needed polyfills here ... -->

  <!-- Rx -->
  <script src="./assets/rxjs/rxjs.umd.js"></script>

  <!-- Angular Packages -->
  <script src="./assets/core/bundles/core.umd.js"></script>
  <script src="./assets/common/bundles/common.umd.js"></script>
  <script src="./assets/common/bundles/common-http.umd.js"></script>
  <script src="./assets/elements/bundles/elements.umd.js"></script>

  <script src="./assets/forms/bundles/forms.umd.js"></script>
  <script src="./assets/router/bundles/router.umd.js"></script>

  <!-- TODO: Add further needed Angular libs here ... -->

  <!-- Just needed for prod mode -->
  <script src="./assets/platform-browser/bundles/platform-browser.umd.js"></script>

`;
function addExternalsSupport(_options) {
    return (tree, _context) => {
        const project = getProject(tree, _options);
        const relProjectRootPath = project.root.replace(/[^\/]+/g, '..') || '';
        updateIndexHtml(_options, tree);
        // The host decides about prod mode 
        // when sharing deps
        if (!_options.host) {
            removeEnableProdModeInMainTs(_options, tree);
        }
        emptyPolyfillsTs(_options, tree);
        updatePackageJson(project.root || '', tree, _options);
        const templateSource = schematics_1.apply(schematics_1.url('./files'), [
            schematics_1.template(Object.assign({}, _options, { relProjectRootPath, projectRoot: project.root || '' })),
            schematics_1.move(project.root || '/')
        ]);
        const rule = schematics_1.chain([
            schematics_1.branchAndMerge(schematics_1.mergeWith(templateSource))
        ]);
        const packageJson = loadPackageJson(tree);
        if ((!packageJson['dependencies'] || !packageJson['dependencies']['copy'])
            && (!packageJson['devDependencies'] || !packageJson['devDependencies']['copy'])) {
            const id = _context.addTask(new tasks_1.NodePackageInstallTask({
                packageName: 'copy',
            }));
            _context.addTask(new tasks_1.RunSchematicTask('npmRun', { script: 'npx-build-plus:copy-assets' }), [id]);
        }
        else {
            _context.addTask(new tasks_1.RunSchematicTask('npmRun', { script: 'npx-build-plus:copy-assets' }));
        }
        return rule(tree, _context);
    };
}
exports.addExternalsSupport = addExternalsSupport;
function updatePackageJson(path, tree, _options) {
    const config = loadPackageJson(tree);
    updateScripts(path, config, tree, _options);
    savePackageJson(config, tree);
}
function removeEnableProdModeInMainTs(options, tree) {
    const project = getProject(tree, options);
    const fileName = `${project.sourceRoot}/main.ts`;
    const content = tree.read(fileName);
    if (content === null)
        throw Error('could not read main.ts');
    const contentAsString = content.toString('UTF-8');
    const modifiedContent = contentAsString.replace('enableProdMode();', '// Let the host app decide about prod mode\n  // enableProdMode();');
    tree.overwrite(fileName, modifiedContent);
}
function updateIndexHtml(options, tree) {
    const project = getProject(tree, options);
    const fileName = `${project.sourceRoot}/index.html`;
    const indexHtml = tree.read(fileName);
    if (indexHtml === null)
        throw Error('could not read index.html');
    const contentAsString = indexHtml.toString('UTF-8');
    if (contentAsString.indexOf('.umd.js') > -1) {
        console.info('Seems like, UMD bundles are already referenced by index.html');
        return;
    }
    const modifiedContent = contentAsString.replace('</body>', scripts + '\n</body>');
    tree.overwrite(fileName, modifiedContent);
}
function emptyPolyfillsTs(options, tree) {
    const project = getProject(tree, options);
    const fileName = `${project.sourceRoot}/polyfills.ts`;
    const bakFileName = `${project.sourceRoot}/polyfills.ts.bak`;
    const content = tree.read(fileName);
    if (content === null)
        throw Error('could not read polyfills.ts');
    const contentAsString = content.toString('UTF-8');
    if (!tree.exists(bakFileName)) {
        tree.create(bakFileName, contentAsString);
    }
    tree.overwrite(fileName, `
// in extenals mode, polyfills are directly loaded into index.html
// to make sure everything is loaded in the right order
// the original contents of this file has been moved to polyfills.ts.bak
  `);
}
function getProject(tree, options) {
    const workspace = config_1.getWorkspace(tree);
    if (!options.project) {
        options.project = Object.keys(workspace.projects)[0];
    }
    const project = workspace.projects[options.project];
    // compensate for lacking sourceRoot property
    // e. g. when project was migrated to ng7, sourceRoot is lacking
    if (!project.sourceRoot && !project.root) {
        project.sourceRoot = 'src';
    }
    else if (!project.sourceRoot) {
        project.sourceRoot = path.join(project.root, 'src');
    }
    return project;
}
function savePackageJson(config, tree) {
    const newContentAsString = JSON.stringify(config, null, 2) || '';
    tree.overwrite('package.json', newContentAsString);
}
function loadPackageJson(tree) {
    const pkg = tree.read('package.json');
    if (pkg === null)
        throw Error('could not read package.json');
    const contentAsString = pkg.toString('UTF-8');
    const config = JSON.parse(contentAsString);
    return config;
}
function updateScripts(path, config, tree, _options) {
    const project = getProject(tree, _options);
    if (!config['scripts']) {
        config.scripts = {};
    }
    const script = `node ${path}copy-bundles.js`;
    let copyAssetsScript = config.scripts['npx-build-plus:copy-assets'];
    if (!copyAssetsScript) {
        copyAssetsScript = script;
    }
    else if (!copyAssetsScript.includes(script)) {
        copyAssetsScript += ' && ' + script;
    }
    config.scripts['npx-build-plus:copy-assets'] = copyAssetsScript;
    let additionalFlags = '';
    if (!_options.host) {
        // external web components need single bundle w/ output hashing
        additionalFlags = '--single-bundle --output-hashing none';
    }
    // Heuristic for default project
    if (!project.root) {
        config.scripts['build:externals'] = `ng build --extra-webpack-config webpack.externals.js --prod ${additionalFlags}`;
    }
    if (_options.project) {
        config.scripts[`build:${_options.project}:externals`] = `ng build --extra-webpack-config webpack.externals.js --prod --project ${_options.project} ${additionalFlags}`;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiLi8iLCJzb3VyY2VzIjpbInNjaGVtYXRpY3MvZXh0ZXJuYWxzL2luZGV4LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsMkRBQXdJO0FBQ3hJLCtEQUFrRTtBQUNsRSw0REFBNEY7QUFDNUYsNkJBQTZCO0FBRTdCLE1BQU0sS0FBSyxHQUFHLE9BQU8sQ0FBQyxhQUFhLENBQUMsQ0FBQztBQUVyQyxNQUFNLE9BQU8sR0FBRzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Q0E0Q2YsQ0FBQTtBQUVELFNBQWdCLG1CQUFtQixDQUFDLFFBQWE7SUFDL0MsT0FBTyxDQUFDLElBQVUsRUFBRSxRQUEwQixFQUFFLEVBQUU7UUFFaEQsTUFBTSxPQUFPLEdBQUcsVUFBVSxDQUFDLElBQUksRUFBRSxRQUFRLENBQUMsQ0FBQztRQUUzQyxNQUFNLGtCQUFrQixHQUNoQixPQUFPLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxTQUFTLEVBQUUsSUFBSSxDQUFDLElBQUksRUFBRSxDQUFDO1FBRXBELGVBQWUsQ0FBQyxRQUFRLEVBQUUsSUFBSSxDQUFDLENBQUM7UUFFaEMsb0NBQW9DO1FBQ3BDLG9CQUFvQjtRQUNwQixJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksRUFBRTtZQUNsQiw0QkFBNEIsQ0FBQyxRQUFRLEVBQUUsSUFBSSxDQUFDLENBQUM7U0FDOUM7UUFFRCxnQkFBZ0IsQ0FBQyxRQUFRLEVBQUUsSUFBSSxDQUFDLENBQUM7UUFFakMsaUJBQWlCLENBQUMsT0FBTyxDQUFDLElBQUksSUFBSSxFQUFFLEVBQUUsSUFBSSxFQUFFLFFBQVEsQ0FBQyxDQUFDO1FBRXRELE1BQU0sY0FBYyxHQUFHLGtCQUFLLENBQUMsZ0JBQUcsQ0FBQyxTQUFTLENBQUMsRUFBRTtZQUMzQyxxQkFBUSxtQkFBSyxRQUFRLElBQUUsa0JBQWtCLEVBQUUsV0FBVyxFQUFFLE9BQU8sQ0FBQyxJQUFJLElBQUks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QUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBSdWxlLCBTY2hlbWF0aWNDb250ZXh0LCBUcmVlLCBhcHBseSwgdXJsLCB0ZW1wbGF0ZSwgbW92ZSwgYnJhbmNoQW5kTWVyZ2UsIG1lcmdlV2l0aCwgY2hhaW4gfSBmcm9tICdAYW5ndWxhci1kZXZraXQvc2NoZW1hdGljcyc7XG5pbXBvcnQgeyBnZXRXb3Jrc3BhY2UgfSBmcm9tICdAc2NoZW1hdGljcy9hbmd1bGFyL3V0aWxpdHkvY29uZmlnJztcbmltcG9ydCB7IFJ1blNjaGVtYXRpY1Rhc2ssIE5vZGVQYWNrYWdlSW5zdGFsbFRhc2sgfSBmcm9tICdAYW5ndWxhci1kZXZraXQvc2NoZW1hdGljcy90YXNrcyc7XG5pbXBvcnQgKiBhcyBwYXRoIGZyb20gJ3BhdGgnO1xuXG5jb25zdCBzcGF3biA9IHJlcXVpcmUoJ2Nyb3NzLXNwYXduJyk7XG5cbmNvbnN0IHNjcmlwdHMgPSBgXG5cbiAgPCEtLSBIZXJlLCBhbGwgdGhlIHNoYXJlZCBjb2RlIGlzIGltcG9ydGVkIC0tPlxuICA8IS0tIGNvbnNpZGVyIGNyZWF0aW5nIG9uZSBvciBzZXZlcmFsIGJ1bmRsZXMgLS0+XG4gIDwhLS0gZm9yIHRob3NlIC0tPlxuXG4gIDwhLS0gY29yZS1qcyBmb3IgbGVnYWN5IGJyb3dzZXJzIFxuICAgICAgICBDb25zaWRlciBvbmx5IGxvYWRpbmcgZm9yIElFXG4gIC0tPlxuICA8c2NyaXB0IHNyYz1cIi4vYXNzZXRzL2NvcmUtanMvY29yZS5qc1wiPjwvc2NyaXB0PlxuXG4gIDwhLS0gXG4gICAgICAgIFdlYiBDb21wb25lbnQgcG9seWZpbGxzXG4gIC0tPlxuICA8c2NyaXB0IHNyYz1cIi9hc3NldHMvd2ViY29tcG9uZW50c2pzL2J1bmRsZXMvd2ViY29tcG9uZW50cy1zZC1jZS5qc1wiPjwvc2NyaXB0PlxuXG4gIDwhLS0gWm9uZS5qcyBcbiAgICAgICAgQ29uc2lkZXIgZXhjbHVkaW5nIHpvbmUuanMgd2hlbiBjcmVhdGluZ1xuICAgICAgICBjdXN0b20gRWxlbWVudHMgYnkgdXNpbmcgdGhlIG5vb3Agem9uZS5cblxuICAgICAgICBJZiB5b3UgbG9hZCB6b25lLmpzIHdpdGggYW4gYWRkaXRpb25hbCBcbiAgICAgICAgYnVuZGxlLCBkZWxldGUgdGhpcyBsaW5lLlxuICAtLT5cbiAgPHNjcmlwdCBzcmM9XCIuL2Fzc2V0cy96b25lLmpzL3pvbmUuanNcIj48L3NjcmlwdD5cblxuICA8IS0tIFRPRE86IEFkZCBmdXJ0aGVyIG5lZWRlZCBwb2x5ZmlsbHMgaGVyZSAuLi4gLS0+XG5cbiAgPCEtLSBSeCAtLT5cbiAgPHNjcmlwdCBzcmM9XCIuL2Fzc2V0cy9yeGpzL3J4anMudW1kLmpzXCI+PC9zY3JpcHQ+XG5cbiAgPCEtLSBBbmd1bGFyIFBhY2thZ2VzIC0tPlxuICA8c2NyaXB0IHNyYz1cIi4vYXNzZXRzL2NvcmUvYnVuZGxlcy9jb3JlLnVtZC5qc1wiPjwvc2NyaXB0PlxuICA8c2NyaXB0IHNyYz1cIi4vYXNzZXRzL2NvbW1vbi9idW5kbGVzL2NvbW1vbi51bWQuanNcIj48L3NjcmlwdD5cbiAgPHNjcmlwdCBzcmM9XCIuL2Fzc2V0cy9jb21tb24vYnVuZGxlcy9jb21tb24taHR0cC51bWQuanNcIj48L3NjcmlwdD5cbiAgPHNjcmlwdCBzcmM9XCIuL2Fzc2V0cy9lbGVtZW50cy9idW5kbGVzL2VsZW1lbnRzLnVtZC5qc1wiPjwvc2NyaXB0PlxuXG4gIDxzY3JpcHQgc3JjPVwiLi9hc3NldHMvZm9ybXMvYnVuZGxlcy9mb3Jtcy51bWQuanNcIj48L3NjcmlwdD5cbiAgPHNjcmlwdCBzcmM9XCIuL2Fzc2V0cy9yb3V0ZXIvYnVuZGxlcy9yb3V0ZXIudW1kLmpzXCI+PC9zY3JpcHQ+XG5cbiAgPCEtLSBUT0RPOiBBZGQgZnVydGhlciBuZWVkZWQgQW5ndWxhciBsaWJzIGhlcmUgLi4uIC0tPlxuXG4gIDwhLS0gSnVzdCBuZWVkZWQgZm9yIHByb2QgbW9kZSAtLT5cbiAgPHNjcmlwdCBzcmM9XCIuL2Fzc2V0cy9wbGF0Zm9ybS1icm93c2VyL2J1bmRsZXMvcGxhdGZvcm0tYnJvd3Nlci51bWQuanNcIj48L3NjcmlwdD5cblxuYFxuXG5leHBvcnQgZnVuY3Rpb24gYWRkRXh0ZXJuYWxzU3VwcG9ydChfb3B0aW9uczogYW55KTogUnVsZSB7XG4gIHJldHVybiAodHJlZTogVHJlZSwgX2NvbnRleHQ6IFNjaGVtYXRpY0NvbnRleHQpID0+IHtcbiAgICBcbiAgICBjb25zdCBwcm9qZWN0ID0gZ2V0UHJvamVjdCh0cmVlLCBfb3B0aW9ucyk7XG5cbiAgICBjb25zdCByZWxQcm9qZWN0Um9vdFBhdGggPSBcbiAgICAgICAgICAgIHByb2plY3Qucm9vdC5yZXBsYWNlKC9bXlxcL10rL2csICcuLicpIHx8ICcnO1xuXG4gICAgdXBkYXRlSW5kZXhIdG1sKF9vcHRpb25zLCB0cmVlKTtcbiAgICBcbiAgICAvLyBUaGUgaG9zdCBkZWNpZGVzIGFib3V0IHByb2QgbW9kZSBcbiAgICAvLyB3aGVuIHNoYXJpbmcgZGVwc1xuICAgIGlmICghX29wdGlvbnMuaG9zdCkge1xuICAgICAgcmVtb3ZlRW5hYmxlUHJvZE1vZGVJbk1haW5Ucyhfb3B0aW9ucywgdHJlZSk7XG4gICAgfVxuXG4gICAgZW1wdHlQb2x5ZmlsbHNUcyhfb3B0aW9ucywgdHJlZSk7XG5cbiAgICB1cGRhdGVQYWNrYWdlSnNvbihwcm9qZWN0LnJvb3QgfHwgJycsIHRyZWUsIF9vcHRpb25zKTtcbiAgICBcbiAgICBjb25zdCB0ZW1wbGF0ZVNvdXJjZSA9IGFwcGx5KHVybCgnLi9maWxlcycpLCBbXG4gICAgICB0ZW1wbGF0ZSh7Li4uX29wdGlvbnMsIHJlbFByb2plY3RSb290UGF0aCwgcHJvamVjdFJvb3Q6IHByb2plY3Qucm9vdCB8fCAnJ30pLFxuICAgICAgbW92ZShwcm9qZWN0LnJvb3QgfHwgJy8nKVxuICAgIF0pO1xuXG4gICAgY29uc3QgcnVsZSA9IFxuICAgICAgY2hhaW4oW1xuICAgICAgICBicmFuY2hBbmRNZXJnZShtZXJnZVdpdGgodGVtcGxhdGVTb3VyY2UpKVxuICAgICAgXSk7XG5cbiAgICAgIGNvbnN0IHBhY2thZ2VKc29uID0gbG9hZFBhY2thZ2VKc29uKHRyZWUpO1xuXG4gICAgICBpZiAoXG4gICAgICAgICghcGFja2FnZUpzb25bJ2RlcGVuZGVuY2llcyddIHx8ICFwYWNrYWdlSnNvblsnZGVwZW5kZW5jaWVzJ11bJ2NvcHknXSkgXG4gICAgICAgICYmICghcGFja2FnZUpzb25bJ2RldkRlcGVuZGVuY2llcyddIHx8ICFwYWNrYWdlSnNvblsnZGV2RGVwZW5kZW5jaWVzJ11bJ2NvcHknXSkgXG4gICAgICApIHtcbiAgXG4gICAgICBjb25zdCBpZCA9IF9jb250ZXh0LmFkZFRhc2sobmV3IE5vZGVQYWNrYWdlSW5zdGFsbFRhc2soe1xuICAgICAgICAgIHBhY2thZ2VOYW1lOiAnY29weScsXG4gICAgICB9KSk7XG4gIFxuICAgICAgX2NvbnRleHQuYWRkVGFzayhuZXcgUnVuU2NoZW1hdGljVGFzaygnbnBtUnVuJywge3NjcmlwdDogJ25weC1idWlsZC1wbHVzOmNvcHktYXNzZXRzJ30pLCBbaWRdKTtcbiAgICB9XG4gICAgZWxzZSB7XG4gICAgICBfY29udGV4dC5hZGRUYXNrKG5ldyBSdW5TY2hlbWF0aWNUYXNrKCducG1SdW4nLCB7c2NyaXB0OiAnbnB4LWJ1aWxkLXBsdXM6Y29weS1hc3NldHMnfSkpO1xuICAgIH1cbiAgICByZXR1cm4gcnVsZSh0cmVlLCBfY29udGV4dCk7XG4gIH07XG59XG5cbmZ1bmN0aW9uIHVwZGF0ZVBhY2thZ2VKc29uKHBhdGg6IHN0cmluZywgdHJlZTogVHJlZSwgX29wdGlvbnM6IGFueSkge1xuICBjb25zdCBjb25maWcgPSBsb2FkUGFja2FnZUpzb24odHJlZSk7XG4gIHVwZGF0ZVNjcmlwdHMocGF0aCwgY29uZmlnLCB0cmVlLCBfb3B0aW9ucyk7XG4gIHNhdmVQYWNrYWdlSnNvbihjb25maWcsIHRyZWUpO1xufVxuXG5mdW5jdGlvbiByZW1vdmVFbmFibGVQcm9kTW9kZUluTWFpblRzKG9wdGlvbnM6IGFueSwgdHJlZTogVHJlZSkge1xuICBjb25zdCBwcm9qZWN0ID0gZ2V0UHJvamVjdCh0cmVlLCBvcHRpb25zKTtcblxuICBjb25zdCBmaWxlTmFtZSA9IGAke3Byb2plY3Quc291cmNlUm9vdH0vbWFpbi50c2A7XG5cbiAgY29uc3QgY29udGVudCA9IHRyZWUucmVhZChmaWxlTmFtZSk7XG4gIGlmIChjb250ZW50ID09PSBudWxsKVxuICAgIHRocm93IEVycm9yKCdjb3VsZCBub3QgcmVhZCBtYWluLnRzJyk7XG4gIGNvbnN0IGNvbnRlbnRBc1N0cmluZyA9IGNvbnRlbnQudG9TdHJpbmcoJ1VURi04Jyk7XG4gIFxuICBjb25zdCBtb2RpZmllZENvbnRlbnQgPSBjb250ZW50QXNTdHJpbmcucmVwbGFjZSgnZW5hYmxlUHJvZE1vZGUoKTsnLCAnLy8gTGV0IHRoZSBob3N0IGFwcCBkZWNpZGUgYWJvdXQgcHJvZCBtb2RlXFxuICAvLyBlbmFibGVQcm9kTW9kZSgpOycpO1xuXG4gIHRyZWUub3ZlcndyaXRlKGZpbGVOYW1lLCBtb2RpZmllZENvbnRlbnQpO1xufVxuXG5mdW5jdGlvbiB1cGRhdGVJbmRleEh0bWwob3B0aW9uczogYW55LCB0cmVlOiBUcmVlKSB7XG4gIGNvbnN0IHByb2plY3QgPSBnZXRQcm9qZWN0KHRyZWUsIG9wdGlvbnMpO1xuXG4gIGNvbnN0IGZpbGVOYW1lID0gYCR7cHJvamVjdC5zb3VyY2VSb290fS9pbmRleC5odG1sYDtcblxuICBjb25zdCBpbmRleEh0bWwgPSB0cmVlLnJlYWQoZmlsZU5hbWUpO1xuICBpZiAoaW5kZXhIdG1sID09PSBudWxsKVxuICAgIHRocm93IEVycm9yKCdjb3VsZCBub3QgcmVhZCBpbmRleC5odG1sJyk7XG4gIGNvbnN0IGNvbnRlbnRBc1N0cmluZyA9IGluZGV4SHRtbC50b1N0cmluZygnVVRGLTgnKTtcbiAgXG4gIGlmIChjb250ZW50QXNTdHJpbmcuaW5kZXhPZignLnVtZC5qcycpID4gLTEpIHtcbiAgICBjb25zb2xlLmluZm8oJ1NlZW1zIGxpa2UsIFVNRCBidW5kbGVzIGFyZSBhbHJlYWR5IHJlZmVyZW5jZWQgYnkgaW5kZXguaHRtbCcpO1xuICAgIHJldHVybjtcbiAgfVxuXG4gIGNvbnN0IG1vZGlmaWVkQ29udGVudCA9IGNvbnRlbnRBc1N0cmluZy5yZXBsYWNlKCc8L2JvZHk+Jywgc2NyaXB0cyArICdcXG48L2JvZHk+Jyk7XG5cbiAgdHJlZS5vdmVyd3JpdGUoZmlsZU5hbWUsIG1vZGlmaWVkQ29udGVudCk7XG59XG5cblxuZnVuY3Rpb24gZW1wdHlQb2x5ZmlsbHNUcyhvcHRpb25zOiBhbnksIHRyZWU6IFRyZWUpIHtcbiAgY29uc3QgcHJvamVjdCA9IGdldFByb2plY3QodHJlZSwgb3B0aW9ucyk7XG5cbiAgY29uc3QgZmlsZU5hbWUgPSBgJHtwcm9qZWN0LnNvdXJjZVJvb3R9L3BvbHlmaWxscy50c2A7XG4gIGNvbnN0IGJha0ZpbGVOYW1lID0gYCR7cHJvamVjdC5zb3VyY2VSb290fS9wb2x5ZmlsbHMudHMuYmFrYDtcblxuICBjb25zdCBjb250ZW50ID0gdHJlZS5yZWFkKGZpbGVOYW1lKTtcbiAgaWYgKGNvbnRlbnQgPT09IG51bGwpXG4gICAgdGhyb3cgRXJyb3IoJ2NvdWxkIG5vdCByZWFkIHBvbHlmaWxscy50cycpO1xuICBjb25zdCBjb250ZW50QXNTdHJpbmcgPSBjb250ZW50LnRvU3RyaW5nKCdVVEYtOCcpO1xuICBcbiAgaWYgKCF0cmVlLmV4aXN0cyhiYWtGaWxlTmFtZSkpIHtcbiAgICB0cmVlLmNyZWF0ZShiYWtGaWxlTmFtZSwgY29udGVudEFzU3RyaW5nKTtcbiAgfVxuXG4gIHRyZWUub3ZlcndyaXRlKGZpbGVOYW1lLCBgXG4vLyBpbiBleHRlbmFscyBtb2RlLCBwb2x5ZmlsbHMgYXJlIGRpcmVjdGx5IGxvYWRlZCBpbnRvIGluZGV4Lmh0bWxcbi8vIHRvIG1ha2Ugc3VyZSBldmVyeXRoaW5nIGlzIGxvYWRlZCBpbiB0aGUgcmlnaHQgb3JkZXJcbi8vIHRoZSBvcmlnaW5hbCBjb250ZW50cyBvZiB0aGlzIGZpbGUgaGFzIGJlZW4gbW92ZWQgdG8gcG9seWZpbGxzLnRzLmJha1xuICBgKTtcbn1cblxuXG5mdW5jdGlvbiBnZXRQcm9qZWN0KHRyZWU6IFRyZWUsIG9wdGlvbnM6IGFueSkge1xuICBjb25zdCB3b3Jrc3BhY2UgPSBnZXRXb3Jrc3BhY2UodHJlZSk7XG4gIGlmICghb3B0aW9ucy5wcm9qZWN0KSB7XG4gICAgb3B0aW9ucy5wcm9qZWN0ID0gT2JqZWN0LmtleXMod29ya3NwYWNlLnByb2plY3RzKVswXTtcbiAgfVxuICBjb25zdCBwcm9qZWN0ID0gd29ya3NwYWNlLnByb2plY3RzW29wdGlvbnMucHJvamVjdF07XG5cbiAgLy8gY29tcGVuc2F0ZSBmb3IgbGFja2luZyBzb3VyY2VSb290IHByb3BlcnR5XG4gIC8vIGUuIGcuIHdoZW4gcHJvamVjdCB3YXMgbWlncmF0ZWQgdG8gbmc3LCBzb3VyY2VSb290IGlzIGxhY2tpbmdcbiAgaWYgKCFwcm9qZWN0LnNvdXJjZVJvb3QgJiYgIXByb2plY3Qucm9vdCkge1xuICAgIHByb2plY3Quc291cmNlUm9vdCA9ICdzcmMnO1xuICB9XG4gIGVsc2UgaWYgKCFwcm9qZWN0LnNvdXJjZVJvb3QpIHtcbiAgICBwcm9qZWN0LnNvdXJjZVJvb3QgPSBwYXRoLmpvaW4ocHJvamVjdC5yb290LCAnc3JjJyk7XG4gIH1cblxuICByZXR1cm4gcHJvamVjdDtcbn1cblxuZnVuY3Rpb24gc2F2ZVBhY2thZ2VKc29uKGNvbmZpZzogYW55LCB0cmVlOiBUcmVlKSB7XG4gIGNvbnN0IG5ld0NvbnRlbnRBc1N0cmluZyA9IEpTT04uc3RyaW5naWZ5KGNvbmZpZywgbnVsbCwgMikgfHwgJyc7XG4gIHRyZWUub3ZlcndyaXRlKCdwYWNrYWdlLmpzb24nLCBuZXdDb250ZW50QXNTdHJpbmcpO1xufVxuXG5mdW5jdGlvbiBsb2FkUGFja2FnZUpzb24odHJlZTogVHJlZSkge1xuICBjb25zdCBwa2cgPSB0cmVlLnJlYWQoJ3BhY2thZ2UuanNvbicpO1xuICBpZiAocGtnID09PSBudWxsKVxuICAgIHRocm93IEVycm9yKCdjb3VsZCBub3QgcmVhZCBwYWNrYWdlLmpzb24nKTtcbiAgY29uc3QgY29udGVudEFzU3RyaW5nID0gcGtnLnRvU3RyaW5nKCdVVEYtOCcpO1xuICBjb25zdCBjb25maWcgPSBKU09OLnBhcnNlKGNvbnRlbnRBc1N0cmluZyk7XG4gIHJldHVybiBjb25maWc7XG59XG5cbmZ1bmN0aW9uIHVwZGF0ZVNjcmlwdHMocGF0aDogc3RyaW5nLCBjb25maWc6IGFueSwgdHJlZTogVHJlZSwgX29wdGlvbnM6IGFueSkge1xuICBjb25zdCBwcm9qZWN0ID0gZ2V0UHJvamVjdCh0cmVlLCBfb3B0aW9ucyk7XG4gIFxuICBpZiAoIWNvbmZpZ1snc2NyaXB0cyddKSB7XG4gICAgY29uZmlnLnNjcmlwdHMgPSB7fTtcbiAgfVxuXG4gIGNvbnN0IHNjcmlwdCA9IGBub2RlICR7cGF0aH1jb3B5LWJ1bmRsZXMuanNgO1xuICBsZXQgY29weUFzc2V0c1NjcmlwdDogc3RyaW5nID0gY29uZmlnLnNjcmlwdHNbJ25weC1idWlsZC1wbHVzOmNvcHktYXNzZXRzJ107XG5cbiAgaWYgKCFjb3B5QXNzZXRzU2NyaXB0KSB7XG4gICAgY29weUFzc2V0c1NjcmlwdCA9IHNjcmlwdDtcbiAgfVxuICBlbHNlIGlmICghY29weUFzc2V0c1NjcmlwdC5pbmNsdWRlcyhzY3JpcHQpKSB7XG4gICAgY29weUFzc2V0c1NjcmlwdCArPSAnICYmICcgKyBzY3JpcHQ7XG4gIH1cblxuICBjb25maWcuc2NyaXB0c1snbnB4LWJ1aWxkLXBsdXM6Y29weS1hc3NldHMnXSA9IGNvcHlBc3NldHNTY3JpcHQ7XG4gIFxuICBsZXQgYWRkaXRpb25hbEZsYWdzID0gJyc7XG5cbiAgaWYgKCFfb3B0aW9ucy5ob3N0KSB7XG4gICAgLy8gZXh0ZXJuYWwgd2ViIGNvbXBvbmVudHMgbmVlZCBzaW5nbGUgYnVuZGxlIHcvIG91dHB1dCBoYXNoaW5nXG4gICAgYWRkaXRpb25hbEZsYWdzID0gJy0tc2luZ2xlLWJ1bmRsZSAtLW91dHB1dC1oYXNoaW5nIG5vbmUnO1xuICB9XG5cbiAgLy8gSGV1cmlzdGljIGZvciBkZWZhdWx0IHByb2plY3RcbiAgaWYgKCFwcm9qZWN0LnJvb3QpIHtcbiAgICBjb25maWcuc2NyaXB0c1snYnVpbGQ6ZXh0ZXJuYWxzJ10gPSBgbmcgYnVpbGQgLS1leHRyYS13ZWJwYWNrLWNvbmZpZyB3ZWJwYWNrLmV4dGVybmFscy5qcyAtLXByb2QgJHthZGRpdGlvbmFsRmxhZ3N9YDtcbiAgfVxuXG4gIGlmIChfb3B0aW9ucy5wcm9qZWN0KSB7XG4gICAgY29uZmlnLnNjcmlwdHNbYGJ1aWxkOiR7X29wdGlvbnMucHJvamVjdH06ZXh0ZXJuYWxzYF0gPSBgbmcgYnVpbGQgLS1leHRyYS13ZWJwYWNrLWNvbmZpZyB3ZWJwYWNrLmV4dGVybmFscy5qcyAtLXByb2QgLS1wcm9qZWN0ICR7X29wdGlvbnMucHJvamVjdH0gJHthZGRpdGlvbmFsRmxhZ3N9YDtcbiAgfVxufSJdfQ==