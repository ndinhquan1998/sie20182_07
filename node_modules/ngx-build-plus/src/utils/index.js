"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const rxjs_1 = require("rxjs");
const operators_1 = require("rxjs/operators");
const load_hook_1 = require("../ext/load-hook");
const core_1 = require("@angular-devkit/core");
const path = require("path");
const webpackMerge = require("webpack-merge");
function runBuilderHandler(options, transforms, context, builderHandler, configTransformerName = 'config') {
    let plugin = null;
    if (options.plugin) {
        plugin = load_hook_1.loadHook(options.plugin);
    }
    setupConfigHook(transforms, options, context, plugin, configTransformerName);
    if (plugin && plugin.pre) {
        plugin.pre(options);
    }
    const result = asObservable(builderHandler(options, context, transforms));
    return result.pipe(operators_1.tap(_ => {
        if (plugin && plugin.post) {
            plugin.post(options);
        }
    }));
}
exports.runBuilderHandler = runBuilderHandler;
function asObservable(result) {
    if (rxjs_1.isObservable(result)) {
        return result;
    }
    if (result instanceof Promise) {
        return rxjs_1.from(result);
    }
    return rxjs_1.of(result);
}
function setupConfigHook(transforms, options, context, plugin, configTransformerName = 'config') {
    const originalConfigFn = transforms[configTransformerName];
    transforms[configTransformerName] = (workspace, config) => {
        if (options.singleBundle) {
            if (!options.keepPolyfills && config.entry && config.entry['polyfills']) {
                delete config.entry['polyfills'];
            }
            if (config.optimization) {
                delete config.optimization.runtimeChunk;
                delete config.optimization.splitChunks;
            }
        }
        if (options.singleBundle && options.bundleStyles !== false && config.entry && config.entry['styles']) {
            delete config.entry['styles'];
        }
        if (options.extraWebpackConfig) {
            const filePath = path.resolve(core_1.getSystemPath(core_1.normalize(context.workspaceRoot)), options.extraWebpackConfig);
            const additionalConfig = require(filePath);
            config = webpackMerge([config, additionalConfig]);
        }
        if (plugin && plugin.config) {
            config = plugin.config(config);
        }
        if (options.configHook) {
            const hook = load_hook_1.loadHook(options.configHook);
            config = hook(config);
        }
        if (originalConfigFn) {
            return originalConfigFn(workspace, config);
        }
        else {
            return rxjs_1.of(config);
        }
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiLi8iLCJzb3VyY2VzIjpbInNyYy91dGlscy9pbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUdBLCtCQUEwRDtBQUMxRCw4Q0FBcUM7QUFFckMsZ0RBQTRDO0FBQzVDLCtDQUE4RTtBQUU5RSw2QkFBNkI7QUFDN0IsOENBQThDO0FBYzlDLFNBQWdCLGlCQUFpQixDQUFDLE9BQVksRUFBRSxVQUFzQixFQUFFLE9BQXVCLEVBQUUsY0FBeUMsRUFBRSxxQkFBcUIsR0FBRyxRQUFRO0lBRTFLLElBQUksTUFBTSxHQUFrQixJQUFJLENBQUM7SUFDakMsSUFBSSxPQUFPLENBQUMsTUFBTSxFQUFFO1FBQ2xCLE1BQU0sR0FBRyxvQkFBUSxDQUFTLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQztLQUMzQztJQUVELGVBQWUsQ0FBQyxVQUFVLEVBQUUsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLEVBQUUscUJBQXFCLENBQUMsQ0FBQztJQUU3RSxJQUFJLE1BQU0sSUFBSSxNQUFNLENBQUMsR0FBRyxFQUFFO1FBQ3hCLE1BQU0sQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLENBQUM7S0FDckI7SUFFRCxNQUFNLE1BQU0sR0FBRyxZQUFZLENBQUMsY0FBYyxDQUFDLE9BQU8sRUFBRSxPQUFPLEVBQUUsVUFBVSxDQUFDLENBQUMsQ0FBQztJQUUxRSxPQUFPLE1BQU0sQ0FBQyxJQUFJLENBQUMsZUFBRyxDQUFDLENBQUMsQ0FBQyxFQUFFO1FBQ3pCLElBQUksTUFBTSxJQUFJLE1BQU0sQ0FBQyxJQUFJLEVBQUU7WUFDekIsTUFBTSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQztTQUN0QjtJQUNILENBQUMsQ0FBQyxDQUFDLENBQUM7QUFDTixDQUFDO0FBcEJELDhDQW9CQztBQUVELFNBQVMsWUFBWSxDQUFDLE1BQXlCO0lBQzdDLElBQUksbUJBQVksQ0FBQyxNQUFNLENBQUMsRUFBRTtRQUN0QixPQUFPLE1BQU0sQ0FBQztLQUNqQjtJQUNELElBQUksTUFBTSxZQUFZLE9BQU8sRUFBRTtRQUM3QixPQUFPLFdBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQztLQUNyQjtJQUNELE9BQU8sU0FBRSxDQUFDLE1BQU0sQ0FBQyxDQUFDO0FBQ3BCLENBQUM7QUFFRCxTQUFTLGVBQWUsQ0FBQyxVQUl4QixFQUFFLE9BQVksRUFBRSxPQUF1QixFQUFFLE1BQXFCLEVBQUUscUJBQXFCLEdBQUcsUUFBUTtJQUMvRixNQUFNLGdCQUFnQixHQUFHLFVBQVUsQ0FBQyxxQkFBcUIsQ0FBQyxDQUFDO0lBQzNELFVBQVUsQ0FBQyxxQkFBcUIsQ0FBQyxHQUFHLENBQUMsU0FBMkMsRUFBRSxNQUE2QixFQUFFLEVBQUU7UUFFakgsSUFBSSxPQUFPLENBQUMsWUFBWSxFQUFFO1lBQ3hCLElBQUksQ0FBQyxPQUFPLENBQUMsYUFBYSxJQUFJLE1BQU0sQ0FBQyxLQUFLLElBQUksTUFBTSxDQUFDLEtBQUssQ0FBQyxXQUFXLENBQUMsRUFBRTtnQkFDdkUsT0FBTyxNQUFNLENBQUMsS0FBSyxDQUFDLFdBQVcsQ0FBQyxDQUFDO2FBQ2xDO1lBQ0QsSUFBSSxNQUFNLENBQUMsWUFBWSxFQUFFO2dCQUN2QixPQUFPLE1BQU0sQ0FBQyxZQUFZLENBQUMsWUFBWSxDQUFDO2dCQUN4QyxPQUFPLE1BQU0sQ0FBQyxZQUFZLENBQUMsV0FBVyxDQUFDO2FBQ3hDO1NBQ0Y7UUFFRCxJQUFJLE9BQU8sQ0FBQyxZQUFZLElBQUksT0FBTyxDQUFDLFlBQVksS0FBSyxLQUFLLElBQUksTUFBTSxDQUFDLEtBQUssSUFBSSxNQUFNLENBQUMsS0FBSyxDQUFDLFFBQVEsQ0FBQyxFQUFFO1lBQ3BHLE9BQU8sTUFBTSxDQUFDLEtBQUssQ0FBQyxRQUFRLENBQUMsQ0FBQztTQUMvQjtRQUVELElBQUksT0FBTyxDQUFDLGtCQUFrQixFQUFFO1lBQzlCLE1BQU0sUUFBUSxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsb0JBQWEsQ0FBQyxnQkFBUyxDQUFDLE9BQU8sQ0FBQyxhQUFhLENBQUMsQ0FBQyxFQUFFLE9BQU8sQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDO1lBQzNHLE1BQU0sZ0JBQWdCLEdBQUcsT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFDO1lBQzNDLE1BQU0sR0FBRyxZQUFZLENBQUMsQ0FBQyxNQUFNLEVBQUUsZ0JBQWdCLENBQUMsQ0FBQyxDQUFDO1NBQ25EO1FBQ0QsSUFBSSxNQUFNLElBQUksTUFBTSxDQUFDLE1BQU0sRUFBRTtZQUMzQixNQUFNLEdBQUcsTUFBTSxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQztTQUNoQztRQUVELElBQUksT0FBTyxDQUFDLFVBQVUsRUFBRTtZQUNwQixNQUFNLElBQUksR0FBRyxvQkFBUSxDQUFlLE9BQU8sQ0FBQyxVQUFVLENBQUMsQ0FBQztZQUN4RCxNQUFNLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDO1NBQ3pCO1FBRUQsSUFBSSxnQkFBZ0IsRUFBRTtZQUNwQixPQUFPLGdCQUFnQixDQUFDLFNBQVMsRUFBRSxNQUFNLENBQUMsQ0FBQztTQUM1QzthQUNJO1lBQ0gsT0FBTyxTQUFFLENBQUMsTUFBTSxDQUFDLENBQUM7U0FDbkI7SUFDSCxDQUFDLENBQUM7QUFDSixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQnJvd3NlckNvbmZpZ1RyYW5zZm9ybUZuLCBCcm93c2VyQnVpbGRlck91dHB1dCB9IGZyb20gXCJAYW5ndWxhci1kZXZraXQvYnVpbGQtYW5ndWxhclwiO1xyXG5pbXBvcnQgeyBCdWlsZGVyQ29udGV4dCwgQnVpbGRlck91dHB1dCwgQnVpbGRlck91dHB1dExpa2UgfSBmcm9tIFwiQGFuZ3VsYXItZGV2a2l0L2FyY2hpdGVjdFwiO1xyXG5pbXBvcnQgeyBXZWJwYWNrTG9nZ2luZ0NhbGxiYWNrIH0gZnJvbSBcIkBhbmd1bGFyLWRldmtpdC9idWlsZC13ZWJwYWNrXCI7XHJcbmltcG9ydCB7IE9ic2VydmFibGUsIG9mLCBmcm9tLCBpc09ic2VydmFibGUgfSBmcm9tICdyeGpzJztcclxuaW1wb3J0IHsgdGFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xyXG5pbXBvcnQgeyBQbHVnaW4sIENvbmZpZ0hvb2tGbiB9IGZyb20gXCIuLi9leHQvaG9va1wiO1xyXG5pbXBvcnQgeyBsb2FkSG9vayB9IGZyb20gXCIuLi9leHQvbG9hZC1ob29rXCI7XHJcbmltcG9ydCB7IGV4cGVyaW1lbnRhbCwgZ2V0U3lzdGVtUGF0aCwgbm9ybWFsaXplIH0gZnJvbSAnQGFuZ3VsYXItZGV2a2l0L2NvcmUnO1xyXG5pbXBvcnQgKiBhcyB3ZWJwYWNrIGZyb20gJ3dlYnBhY2snO1xyXG5pbXBvcnQgKiBhcyBwYXRoIGZyb20gJ3BhdGgnO1xyXG5pbXBvcnQgKiBhcyB3ZWJwYWNrTWVyZ2UgZnJvbSAnd2VicGFjay1tZXJnZSc7XHJcblxyXG5cclxuZXhwb3J0IGludGVyZmFjZSBUcmFuc2Zvcm1zIHtcclxuICBjb25maWc/OiBCcm93c2VyQ29uZmlnVHJhbnNmb3JtRm47XHJcbiAgb3V0cHV0PzogKG91dHB1dDogQnJvd3NlckJ1aWxkZXJPdXRwdXQpID0+IE9ic2VydmFibGU8QnVpbGRlck91dHB1dD47XHJcbiAgbG9nZ2luZz86IFdlYnBhY2tMb2dnaW5nQ2FsbGJhY2s7XHJcbn1cclxuXHJcbmV4cG9ydCBpbnRlcmZhY2UgQnVpbGRlckhhbmRsZXJQbHVzRm48QT4ge1xyXG4gIChpbnB1dDogQSwgY29udGV4dDogQnVpbGRlckNvbnRleHQsIHRyYW5zZm9ybXM6IFRyYW5zZm9ybXMpOiBCdWlsZGVyT3V0cHV0TGlrZTtcclxufVxyXG5cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBydW5CdWlsZGVySGFuZGxlcihvcHRpb25zOiBhbnksIHRyYW5zZm9ybXM6IFRyYW5zZm9ybXMsIGNvbnRleHQ6IEJ1aWxkZXJDb250ZXh0LCBidWlsZGVySGFuZGxlcjogQnVpbGRlckhhbmRsZXJQbHVzRm48YW55PiwgY29uZmlnVHJhbnNmb3JtZXJOYW1lID0gJ2NvbmZpZycpIHtcclxuICBcclxuICBsZXQgcGx1Z2luOiBQbHVnaW4gfCBudWxsID0gbnVsbDtcclxuICBpZiAob3B0aW9ucy5wbHVnaW4pIHtcclxuICAgIHBsdWdpbiA9IGxvYWRIb29rPFBsdWdpbj4ob3B0aW9ucy5wbHVnaW4pO1xyXG4gIH1cclxuXHJcbiAgc2V0dXBDb25maWdIb29rKHRyYW5zZm9ybXMsIG9wdGlvbnMsIGNvbnRleHQsIHBsdWdpbiwgY29uZmlnVHJhbnNmb3JtZXJOYW1lKTtcclxuXHJcbiAgaWYgKHBsdWdpbiAmJiBwbHVnaW4ucHJlKSB7XHJcbiAgICBwbHVnaW4ucHJlKG9wdGlvbnMpO1xyXG4gIH1cclxuXHJcbiAgY29uc3QgcmVzdWx0ID0gYXNPYnNlcnZhYmxlKGJ1aWxkZXJIYW5kbGVyKG9wdGlvbnMsIGNvbnRleHQsIHRyYW5zZm9ybXMpKTtcclxuXHJcbiAgcmV0dXJuIHJlc3VsdC5waXBlKHRhcChfID0+IHtcclxuICAgIGlmIChwbHVnaW4gJiYgcGx1Z2luLnBvc3QpIHtcclxuICAgICAgcGx1Z2luLnBvc3Qob3B0aW9ucyk7XHJcbiAgICB9XHJcbiAgfSkpO1xyXG59XHJcblxyXG5mdW5jdGlvbiBhc09ic2VydmFibGUocmVzdWx0OiBCdWlsZGVyT3V0cHV0TGlrZSkge1xyXG4gIGlmIChpc09ic2VydmFibGUocmVzdWx0KSkge1xyXG4gICAgICByZXR1cm4gcmVzdWx0O1xyXG4gIH1cclxuICBpZiAocmVzdWx0IGluc3RhbmNlb2YgUHJvbWlzZSkge1xyXG4gICAgcmV0dXJuIGZyb20ocmVzdWx0KTtcclxuICB9XHJcbiAgcmV0dXJuIG9mKHJlc3VsdCk7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIHNldHVwQ29uZmlnSG9vayh0cmFuc2Zvcm1zOiB7XHJcbiAgY29uZmlnPzogQnJvd3NlckNvbmZpZ1RyYW5zZm9ybUZuIHwgdW5kZWZpbmVkO1xyXG4gIG91dHB1dD86ICgob3V0cHV0OiBCcm93c2VyQnVpbGRlck91dHB1dCkgPT4gT2JzZXJ2YWJsZTxCdWlsZGVyT3V0cHV0PikgfCB1bmRlZmluZWQ7XHJcbiAgbG9nZ2luZz86IFdlYnBhY2tMb2dnaW5nQ2FsbGJhY2sgfCB1bmRlZmluZWQ7XHJcbn0sIG9wdGlvbnM6IGFueSwgY29udGV4dDogQnVpbGRlckNvbnRleHQsIHBsdWdpbjogUGx1Z2luIHwgbnVsbCwgY29uZmlnVHJhbnNmb3JtZXJOYW1lID0gJ2NvbmZpZycpIHtcclxuICBjb25zdCBvcmlnaW5hbENvbmZpZ0ZuID0gdHJhbnNmb3Jtc1tjb25maWdUcmFuc2Zvcm1lck5hbWVdO1xyXG4gIHRyYW5zZm9ybXNbY29uZmlnVHJhbnNmb3JtZXJOYW1lXSA9ICh3b3Jrc3BhY2U6IGV4cGVyaW1lbnRhbC53b3Jrc3BhY2UuV29ya3NwYWNlLCBjb25maWc6IHdlYnBhY2suQ29uZmlndXJhdGlvbikgPT4ge1xyXG5cclxuICAgIGlmIChvcHRpb25zLnNpbmdsZUJ1bmRsZSkge1xyXG4gICAgICBpZiAoIW9wdGlvbnMua2VlcFBvbHlmaWxscyAmJiBjb25maWcuZW50cnkgJiYgY29uZmlnLmVudHJ5Wydwb2x5ZmlsbHMnXSkge1xyXG4gICAgICAgIGRlbGV0ZSBjb25maWcuZW50cnlbJ3BvbHlmaWxscyddO1xyXG4gICAgICB9XHJcbiAgICAgIGlmIChjb25maWcub3B0aW1pemF0aW9uKSB7XHJcbiAgICAgICAgZGVsZXRlIGNvbmZpZy5vcHRpbWl6YXRpb24ucnVudGltZUNodW5rO1xyXG4gICAgICAgIGRlbGV0ZSBjb25maWcub3B0aW1pemF0aW9uLnNwbGl0Q2h1bmtzO1xyXG4gICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKG9wdGlvbnMuc2luZ2xlQnVuZGxlICYmIG9wdGlvbnMuYnVuZGxlU3R5bGVzICE9PSBmYWxzZSAmJiBjb25maWcuZW50cnkgJiYgY29uZmlnLmVudHJ5WydzdHlsZXMnXSkge1xyXG4gICAgICBkZWxldGUgY29uZmlnLmVudHJ5WydzdHlsZXMnXTtcclxuICAgIH1cclxuXHJcbiAgICBpZiAob3B0aW9ucy5leHRyYVdlYnBhY2tDb25maWcpIHtcclxuICAgICAgY29uc3QgZmlsZVBhdGggPSBwYXRoLnJlc29sdmUoZ2V0U3lzdGVtUGF0aChub3JtYWxpemUoY29udGV4dC53b3Jrc3BhY2VSb290KSksIG9wdGlvbnMuZXh0cmFXZWJwYWNrQ29uZmlnKTtcclxuICAgICAgY29uc3QgYWRkaXRpb25hbENvbmZpZyA9IHJlcXVpcmUoZmlsZVBhdGgpO1xyXG4gICAgICBjb25maWcgPSB3ZWJwYWNrTWVyZ2UoW2NvbmZpZywgYWRkaXRpb25hbENvbmZpZ10pO1xyXG4gICAgfVxyXG4gICAgaWYgKHBsdWdpbiAmJiBwbHVnaW4uY29uZmlnKSB7XHJcbiAgICAgIGNvbmZpZyA9IHBsdWdpbi5jb25maWcoY29uZmlnKTtcclxuICAgIH1cclxuXHJcbiAgICBpZiAob3B0aW9ucy5jb25maWdIb29rKSB7XHJcbiAgICAgICAgY29uc3QgaG9vayA9IGxvYWRIb29rPENvbmZpZ0hvb2tGbj4ob3B0aW9ucy5jb25maWdIb29rKTtcclxuICAgICAgICBjb25maWcgPSBob29rKGNvbmZpZyk7XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKG9yaWdpbmFsQ29uZmlnRm4pIHtcclxuICAgICAgcmV0dXJuIG9yaWdpbmFsQ29uZmlnRm4od29ya3NwYWNlLCBjb25maWcpO1xyXG4gICAgfVxyXG4gICAgZWxzZSB7XHJcbiAgICAgIHJldHVybiBvZihjb25maWcpO1xyXG4gICAgfVxyXG4gIH07XHJcbn1cclxuIl19