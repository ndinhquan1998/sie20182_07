"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const build_angular_1 = require("@angular-devkit/build-angular");
const core_1 = require("@angular-devkit/core");
const path = require("path");
const operators_1 = require("rxjs/operators");
const load_hook_1 = require("../ext/load-hook");
const stats_1 = require("../stats");
const webpackMerge = require('webpack-merge');
class PlusBuilder extends build_angular_1.BrowserBuilder {
    createLoggingFactory() {
        return (verbose) => (stats, config, logger) => {
            // config.stats contains our own stats settings, added during buildWebpackConfig().
            const json = stats.toJson(config.stats);
            if (verbose) {
                logger.info(stats.toString(config.stats));
            }
            else {
                logger.info(stats_1.statsToString(json, config.stats));
            }
            if (stats.hasWarnings()) {
                logger.warn(stats_1.statsWarningsToString(json, config.stats));
            }
            if (stats.hasErrors()) {
                logger.error(stats_1.statsErrorsToString(json, config.stats));
            }
        };
    }
    buildWebpackConfig(root, projectRoot, host, options) {
        let config = super.buildWebpackConfig(root, projectRoot, host, options);
        if (this.localOptions.singleBundle) {
            if (!this.localOptions.keepPolyfills) {
                delete config.entry.polyfills;
            }
            delete config.optimization.runtimeChunk;
            delete config.optimization.splitChunks;
        }
        if (this.localOptions.singleBundle && this.localOptions.bundleStyles !== false) {
            delete config.entry.styles;
        }
        if (this.localOptions.extraWebpackConfig) {
            const filePath = path.resolve(core_1.getSystemPath(projectRoot), this.localOptions.extraWebpackConfig);
            const additionalConfig = require(filePath);
            config = webpackMerge([config, additionalConfig]);
        }
        let plugin = null;
        if (this.localOptions.plugin) {
            plugin = load_hook_1.loadHook(this.localOptions.plugin);
        }
        if (plugin && plugin.config) {
            config = plugin.config(config);
        }
        if (this.localOptions.configHook) {
            const hook = load_hook_1.loadHook(this.localOptions.configHook);
            config = hook(config);
        }
        return config;
    }
    run(builderConfig) {
        this.localOptions = builderConfig.options;
        let plugin = null;
        if (builderConfig.options.plugin) {
            plugin = load_hook_1.loadHook(builderConfig.options.plugin);
        }
        if (plugin && plugin.pre) {
            plugin.pre(builderConfig);
        }
        return super.run(builderConfig).pipe(operators_1.tap(_ => {
            if (plugin && plugin.post) {
                plugin.post(builderConfig);
            }
        }));
    }
}
exports.PlusBuilder = PlusBuilder;
exports.default = PlusBuilder;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiLi8iLCJzb3VyY2VzIjpbInNyYy9wbHVzL2luZGV4LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsaUVBQXFIO0FBQ3JILCtDQUFzRTtBQUV0RSw2QkFBNkI7QUFLN0IsOENBQXFDO0FBQ3JDLGdEQUE0QztBQUU1QyxvQ0FBcUY7QUFFckYsTUFBTSxZQUFZLEdBQUcsT0FBTyxDQUFDLGVBQWUsQ0FBQyxDQUFDO0FBRTlDLE1BQWEsV0FBWSxTQUFRLDhCQUFjO0lBSW5DLG9CQUFvQjtRQUU1QixPQUFPLENBQUMsT0FBZ0IsRUFBbUIsRUFBRSxDQUM3QyxDQUFDLEtBQUssRUFBRSxNQUFNLEVBQUUsTUFBTSxFQUFFLEVBQUU7WUFDeEIsbUZBQW1GO1lBRW5GLE1BQU0sSUFBSSxHQUFHLEtBQUssQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDO1lBRXhDLElBQUksT0FBTyxFQUFFO2dCQUNYLE1BQU0sQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQzthQUMzQztpQkFBTTtnQkFDTCxNQUFNLENBQUMsSUFBSSxDQUFDLHFCQUFhLENBQUMsSUFBSSxFQUFFLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDO2FBQ2hEO1lBRUQsSUFBSSxLQUFLLENBQUMsV0FBVyxFQUFFLEVBQUU7Z0JBQ3ZCLE1BQU0sQ0FBQyxJQUFJLENBQUMsNkJBQXFCLENBQUMsSUFBSSxFQUFFLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDO2FBQ3hEO1lBQ0QsSUFBSSxLQUFLLENBQUMsU0FBUyxFQUFFLEVBQUU7Z0JBQ3JCLE1BQU0sQ0FBQyxLQUFLLENBQUMsMkJBQW1CLENBQUMsSUFBSSxFQUFFLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDO2FBQ3ZEO1FBQ0gsQ0FBQyxDQUFDO0lBQ0osQ0FBQztJQUVELGtCQUFrQixDQUNoQixJQUFVLEVBQ1YsV0FBaUIsRUFDakIsSUFBOEIsRUFDOUIsT0FBMEI7UUFHMUIsSUFBSSxNQUFNLEdBQUcsS0FBSyxDQUFDLGtCQUFrQixDQUFDLElBQUksRUFBRSxXQUFXLEVBQUUsSUFBSSxFQUFFLE9BQU8sQ0FBQyxDQUFDO1FBRXhFLElBQUksSUFBSSxDQUFDLFlBQVksQ0FBQyxZQUFZLEVBQUU7WUFFbEMsSUFBSSxDQUFDLElBQUksQ0FBQyxZQUFZLENBQUMsYUFBYSxFQUFFO2dCQUNwQyxPQUFPLE1BQU0sQ0FBQyxLQUFLLENBQUMsU0FBUyxDQUFDO2FBQy9CO1lBQ0QsT0FBTyxNQUFNLENBQUMsWUFBWSxDQUFDLFlBQVksQ0FBQztZQUN4QyxPQUFPLE1BQU0sQ0FBQyxZQUFZLENBQUMsV0FBVyxDQUFDO1NBQ3hDO1FBRUQsSUFBSSxJQUFJLENBQUMsWUFBWSxDQUFDLFlBQVksSUFBSSxJQUFJLENBQUMsWUFBWSxDQUFDLFlBQVksS0FBSyxLQUFLLEVBQUU7WUFDOUUsT0FBTyxNQUFNLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQztTQUM1QjtRQUVELElBQUksSUFBSSxDQUFDLFlBQVksQ0FBQyxrQkFBa0IsRUFBRTtZQUN4QyxNQUFNLFFBQVEsR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLG9CQUFhLENBQUMsV0FBVyxDQUFDLEVBQUUsSUFBSSxDQUFDLFlBQVksQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDO1lBQ2hHLE1BQU0sZ0JBQWdCLEdBQUcsT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFDO1lBQzNDLE1BQU0sR0FBRyxZQUFZLENBQUMsQ0FBQyxNQUFNLEVBQUUsZ0JBQWdCLENBQUMsQ0FBQyxDQUFDO1NBQ25EO1FBRUQsSUFBSSxNQUFNLEdBQWtCLElBQUksQ0FBQztRQUNqQyxJQUFJLElBQUksQ0FBQyxZQUFZLENBQUMsTUFBTSxFQUFFO1lBQzVCLE1BQU0sR0FBRyxvQkFBUSxDQUFTLElBQUksQ0FBQyxZQUFZLENBQUMsTUFBTSxDQUFDLENBQUM7U0FDckQ7UUFFRCxJQUFJLE1BQU0sSUFBSSxNQUFNLENBQUMsTUFBTSxFQUFFO1lBQzNCLE1BQU0sR0FBRyxNQUFNLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDO1NBQ2hDO1FBRUQsSUFBSSxJQUFJLENBQUMsWUFBWSxDQUFDLFVBQVUsRUFBRTtZQUNoQyxNQUFNLElBQUksR0FBRyxvQkFBUSxDQUFlLElBQUksQ0FBQyxZQUFZLENBQUMsVUFBVSxDQUFDLENBQUM7WUFDbEUsTUFBTSxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQztTQUN2QjtRQUVELE9BQU8sTUFBTSxDQUFDO0lBQ2hCLENBQUM7SUFFRCxHQUFHLENBQUMsYUFBc0Q7UUFFeEQsSUFBSSxDQUFDLFlBQVksR0FBRyxhQUFhLENBQUMsT0FBTyxDQUFDO1FBQzFDLElBQUksTUFBTSxHQUFrQixJQUFJLENBQUM7UUFDakMsSUFBSSxhQUFhLENBQUMsT0FBTyxDQUFDLE1BQU0sRUFBRTtZQUNoQyxNQUFNLEdBQUcsb0JBQVEsQ0FBUyxhQUFhLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFDO1NBQ3pEO1FBRUQsSUFBSSxNQUFNLElBQUksTUFBTSxDQUFDLEdBQUcsRUFBRTtZQUN4QixNQUFNLENBQUMsR0FBRyxDQUFDLGFBQWEsQ0FBQyxDQUFDO1NBQzNCO1FBRUQsT0FBTyxLQUFLLENBQUMsR0FBRyxDQUFDLGFBQWEsQ0FBQyxDQUFDLElBQUksQ0FDbEMsZUFBRyxDQUFDLENBQUMsQ0FBQyxFQUFFO1lBQ04sSUFBSSxNQUFNLElBQUksTUFBTSxDQUFDLElBQUksRUFBRTtnQkFDekIsTUFBTSxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsQ0FBQzthQUM1QjtRQUNILENBQUMsQ0FBQyxDQUNILENBQUM7SUFFSixDQUFDO0NBQ0Y7QUE3RkQsa0NBNkZDO0FBRUQsa0JBQWUsV0FBVyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQnJvd3NlckJ1aWxkZXIsIE5vcm1hbGl6ZWRCcm93c2VyQnVpbGRlclNjaGVtYSwgQnJvd3NlckJ1aWxkZXJTY2hlbWEgfSBmcm9tICdAYW5ndWxhci1kZXZraXQvYnVpbGQtYW5ndWxhcic7XHJcbmltcG9ydCB7IFBhdGgsIHZpcnR1YWxGcywgZ2V0U3lzdGVtUGF0aCB9IGZyb20gJ0Bhbmd1bGFyLWRldmtpdC9jb3JlJztcclxuaW1wb3J0ICogYXMgZnMgZnJvbSAnZnMnO1xyXG5pbXBvcnQgKiBhcyBwYXRoIGZyb20gJ3BhdGgnO1xyXG5pbXBvcnQgeyBQbHVzQnVpbGRlclNjaGVtYSB9IGZyb20gJy4vc2NoZW1hJztcclxuaW1wb3J0IHsgQ29uZmlnSG9va0ZuLCBQbHVnaW4gfSBmcm9tICcuLi9leHQvaG9vayc7XHJcbmltcG9ydCB7IEJ1aWxkZXJDb25maWd1cmF0aW9uLCBCdWlsZEV2ZW50IH0gZnJvbSAnQGFuZ3VsYXItZGV2a2l0L2FyY2hpdGVjdCc7XHJcbmltcG9ydCB7IE9ic2VydmFibGUgfSBmcm9tICdyeGpzJztcclxuaW1wb3J0IHsgdGFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xyXG5pbXBvcnQgeyBsb2FkSG9vayB9IGZyb20gJy4uL2V4dC9sb2FkLWhvb2snO1xyXG5pbXBvcnQgeyBMb2dnaW5nQ2FsbGJhY2sgfSBmcm9tICdAYW5ndWxhci1kZXZraXQvYnVpbGQtd2VicGFjayc7XHJcbmltcG9ydCB7IHN0YXRzVG9TdHJpbmcsIHN0YXRzV2FybmluZ3NUb1N0cmluZywgc3RhdHNFcnJvcnNUb1N0cmluZyB9IGZyb20gJy4uL3N0YXRzJztcclxuXHJcbmNvbnN0IHdlYnBhY2tNZXJnZSA9IHJlcXVpcmUoJ3dlYnBhY2stbWVyZ2UnKTtcclxuXHJcbmV4cG9ydCBjbGFzcyBQbHVzQnVpbGRlciBleHRlbmRzIEJyb3dzZXJCdWlsZGVyICB7XHJcblxyXG4gIHByaXZhdGUgbG9jYWxPcHRpb25zOiBhbnk7XHJcblxyXG4gIHByb3RlY3RlZCBjcmVhdGVMb2dnaW5nRmFjdG9yeSgpOiAodmVyYm9zZTogYm9vbGVhbikgPT4gTG9nZ2luZ0NhbGxiYWNrICB7XHJcbiAgICBcclxuICAgIHJldHVybiAodmVyYm9zZTogYm9vbGVhbik6IExvZ2dpbmdDYWxsYmFjayA9PlxyXG4gICAgKHN0YXRzLCBjb25maWcsIGxvZ2dlcikgPT4ge1xyXG4gICAgICAvLyBjb25maWcuc3RhdHMgY29udGFpbnMgb3VyIG93biBzdGF0cyBzZXR0aW5ncywgYWRkZWQgZHVyaW5nIGJ1aWxkV2VicGFja0NvbmZpZygpLlxyXG4gICAgICBcclxuICAgICAgY29uc3QganNvbiA9IHN0YXRzLnRvSnNvbihjb25maWcuc3RhdHMpO1xyXG5cclxuICAgICAgaWYgKHZlcmJvc2UpIHtcclxuICAgICAgICBsb2dnZXIuaW5mbyhzdGF0cy50b1N0cmluZyhjb25maWcuc3RhdHMpKTtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICBsb2dnZXIuaW5mbyhzdGF0c1RvU3RyaW5nKGpzb24sIGNvbmZpZy5zdGF0cykpO1xyXG4gICAgICB9XHJcbiAgXHJcbiAgICAgIGlmIChzdGF0cy5oYXNXYXJuaW5ncygpKSB7XHJcbiAgICAgICAgbG9nZ2VyLndhcm4oc3RhdHNXYXJuaW5nc1RvU3RyaW5nKGpzb24sIGNvbmZpZy5zdGF0cykpO1xyXG4gICAgICB9XHJcbiAgICAgIGlmIChzdGF0cy5oYXNFcnJvcnMoKSkge1xyXG4gICAgICAgIGxvZ2dlci5lcnJvcihzdGF0c0Vycm9yc1RvU3RyaW5nKGpzb24sIGNvbmZpZy5zdGF0cykpO1xyXG4gICAgICB9XHJcbiAgICB9O1xyXG4gIH1cclxuXHJcbiAgYnVpbGRXZWJwYWNrQ29uZmlnKFxyXG4gICAgcm9vdDogUGF0aCxcclxuICAgIHByb2plY3RSb290OiBQYXRoLFxyXG4gICAgaG9zdDogdmlydHVhbEZzLkhvc3Q8ZnMuU3RhdHM+LFxyXG4gICAgb3B0aW9uczogUGx1c0J1aWxkZXJTY2hlbWEsXHJcbiAgKSB7XHJcblxyXG4gICAgbGV0IGNvbmZpZyA9IHN1cGVyLmJ1aWxkV2VicGFja0NvbmZpZyhyb290LCBwcm9qZWN0Um9vdCwgaG9zdCwgb3B0aW9ucyk7XHJcblxyXG4gICAgaWYgKHRoaXMubG9jYWxPcHRpb25zLnNpbmdsZUJ1bmRsZSkge1xyXG4gICAgICBcclxuICAgICAgaWYgKCF0aGlzLmxvY2FsT3B0aW9ucy5rZWVwUG9seWZpbGxzKSB7XHJcbiAgICAgICAgZGVsZXRlIGNvbmZpZy5lbnRyeS5wb2x5ZmlsbHM7XHJcbiAgICAgIH0gXHJcbiAgICAgIGRlbGV0ZSBjb25maWcub3B0aW1pemF0aW9uLnJ1bnRpbWVDaHVuaztcclxuICAgICAgZGVsZXRlIGNvbmZpZy5vcHRpbWl6YXRpb24uc3BsaXRDaHVua3M7XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKHRoaXMubG9jYWxPcHRpb25zLnNpbmdsZUJ1bmRsZSAmJiB0aGlzLmxvY2FsT3B0aW9ucy5idW5kbGVTdHlsZXMgIT09IGZhbHNlKSB7XHJcbiAgICAgIGRlbGV0ZSBjb25maWcuZW50cnkuc3R5bGVzO1xyXG4gICAgfVxyXG5cclxuICAgIGlmICh0aGlzLmxvY2FsT3B0aW9ucy5leHRyYVdlYnBhY2tDb25maWcpIHtcclxuICAgICAgY29uc3QgZmlsZVBhdGggPSBwYXRoLnJlc29sdmUoZ2V0U3lzdGVtUGF0aChwcm9qZWN0Um9vdCksIHRoaXMubG9jYWxPcHRpb25zLmV4dHJhV2VicGFja0NvbmZpZyk7XHJcbiAgICAgIGNvbnN0IGFkZGl0aW9uYWxDb25maWcgPSByZXF1aXJlKGZpbGVQYXRoKTtcclxuICAgICAgY29uZmlnID0gd2VicGFja01lcmdlKFtjb25maWcsIGFkZGl0aW9uYWxDb25maWddKTtcclxuICAgIH1cclxuXHJcbiAgICBsZXQgcGx1Z2luOiBQbHVnaW4gfCBudWxsID0gbnVsbDtcclxuICAgIGlmICh0aGlzLmxvY2FsT3B0aW9ucy5wbHVnaW4pIHtcclxuICAgICAgcGx1Z2luID0gbG9hZEhvb2s8UGx1Z2luPih0aGlzLmxvY2FsT3B0aW9ucy5wbHVnaW4pO1xyXG4gICAgfVxyXG5cclxuICAgIGlmIChwbHVnaW4gJiYgcGx1Z2luLmNvbmZpZykge1xyXG4gICAgICBjb25maWcgPSBwbHVnaW4uY29uZmlnKGNvbmZpZyk7XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKHRoaXMubG9jYWxPcHRpb25zLmNvbmZpZ0hvb2spIHtcclxuICAgICAgY29uc3QgaG9vayA9IGxvYWRIb29rPENvbmZpZ0hvb2tGbj4odGhpcy5sb2NhbE9wdGlvbnMuY29uZmlnSG9vayk7XHJcbiAgICAgIGNvbmZpZyA9IGhvb2soY29uZmlnKTtcclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4gY29uZmlnO1xyXG4gIH1cclxuXHJcbiAgcnVuKGJ1aWxkZXJDb25maWc6IEJ1aWxkZXJDb25maWd1cmF0aW9uPFBsdXNCdWlsZGVyU2NoZW1hPik6IE9ic2VydmFibGU8QnVpbGRFdmVudD4ge1xyXG4gICAgXHJcbiAgICB0aGlzLmxvY2FsT3B0aW9ucyA9IGJ1aWxkZXJDb25maWcub3B0aW9ucztcclxuICAgIGxldCBwbHVnaW46IFBsdWdpbiB8IG51bGwgPSBudWxsO1xyXG4gICAgaWYgKGJ1aWxkZXJDb25maWcub3B0aW9ucy5wbHVnaW4pIHtcclxuICAgICAgcGx1Z2luID0gbG9hZEhvb2s8UGx1Z2luPihidWlsZGVyQ29uZmlnLm9wdGlvbnMucGx1Z2luKTtcclxuICAgIH1cclxuXHJcbiAgICBpZiAocGx1Z2luICYmIHBsdWdpbi5wcmUpIHtcclxuICAgICAgcGx1Z2luLnByZShidWlsZGVyQ29uZmlnKTtcclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4gc3VwZXIucnVuKGJ1aWxkZXJDb25maWcpLnBpcGUoXHJcbiAgICAgIHRhcChfID0+IHtcclxuICAgICAgICBpZiAocGx1Z2luICYmIHBsdWdpbi5wb3N0KSB7XHJcbiAgICAgICAgICBwbHVnaW4ucG9zdChidWlsZGVyQ29uZmlnKTtcclxuICAgICAgICB9XHJcbiAgICAgIH0pXHJcbiAgICApO1xyXG5cclxuICB9XHJcbn1cclxuXHJcbmV4cG9ydCBkZWZhdWx0IFBsdXNCdWlsZGVyO1xyXG4iXX0=